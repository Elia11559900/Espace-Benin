<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESPACE BENIN : Service Immobilier</title>
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <!-- Favicon -->
    <link rel="icon" href="img/logo.png" type="image/png">
    <!-- Firebase SDK (Compat versions for Realtime Database) -->
    <script src="https://www.gstatic.com/firebasejs/9.6.6/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.6/firebase-database-compat.js"></script>
    <!-- Google Generative AI SDK -->
    <script type="module">
        import { GoogleGenerativeAI } from "https://cdn.jsdelivr.net/npm/@google/generative-ai/+esm";
        // Make it globally available if needed by older parts of the script
        window.GoogleGenerativeAI = GoogleGenerativeAI;
        // Initialisation (peut être déplacée ou refaite dans le script principal)
        // initializeGeminiAPI(); // Assurez-vous que cette fonction est définie et appelée correctement
    </script>
     <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- PizZip -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pizzip/3.1.4/pizzip.min.js"></script>
    <!-- FileSaver.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <!-- Mammoth (pour .docx) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>
    <!-- Shepherd.js (Visite Guidée) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js"></script>
     <!-- FedaPay -->
    <script src="https://cdn.fedapay.com/checkout.js?v=1.1.7"></script>
    <!-- Axios (optionnel, si utilisé pour API status check) -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

    <style>
        /* --- START OF ENHANCED styles.css --- */
        :root {
            --primary-color: #003366; /* Dark Blue */
            --secondary-color: #FFA500; /* Orange */
            --accent-color: #e69500; /* Darker Orange for hover */
            --primary-darker: #002244; /* Even Darker Blue */

            /* Light Theme */
            --background-light: #ffffff;
            --text-light: #333333;
            --container-bg-light: #f8f9fa; /* Slightly off-white */
            --card-bg-light: #ffffff;
            --input-bg-light: #ffffff;
            --input-text-light: #212529;
            --border-light: #dee2e6;
            --link-color-light: var(--primary-color);
            --modal-bg-light: #ffffff;
            --shadow-light: 0 4px 15px rgba(0, 0, 0, 0.08);
            --shadow-hover-light: 0 8px 25px rgba(0, 0, 0, 0.12);

            /* Dark Theme */
            --background-dark: #121212;
            --text-dark: #e0e0e0;
            --container-bg-dark: #1a1a1a; /* Slightly lighter than background */
            --card-bg-dark: #242424;
            --input-bg-dark: #2c2c2c;
            --input-text-dark: #f0f0f0;
            --border-dark: #444444;
            --link-color-dark: var(--secondary-color);
            --modal-bg-dark: #282828;
            --shadow-dark: 0 4px 15px rgba(0, 0, 0, 0.2);
            --shadow-hover-dark: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        html {
            scroll-behavior: smooth; /* Smooth scrolling for anchor links */
        }

        body {
            font-family: 'Poppins', sans-serif; /* Using Poppins font */
            margin: 0;
            transition: background-color 0.3s ease, color 0.3s ease;
            font-size: 16px; /* Slightly larger base font size */
            line-height: 1.6; /* Improved readability */
        }

        body[data-theme='light'] {
            background-color: var(--background-light);
            color: var(--text-light);
        }

        body[data-theme='dark'] {
            background-color: var(--background-dark);
            color: var(--text-dark);
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px 15px; /* Consistent padding */
            position: relative;
        }

        /* Headings */
        h2 {
            font-weight: 600; /* Slightly bolder */
            margin-bottom: 30px; /* More space below headings */
            color: var(--primary-color);
            text-align: center; /* Center section titles */
            font-size: 2.2em; /* Larger section titles */
        }
        body[data-theme='dark'] h2 {
             color: var(--secondary-color);
        }

        h3 {
             font-weight: 600;
             margin-bottom: 15px;
        }
        h4 {
            font-weight: 500;
             margin-bottom: 10px;
        }

        p {
            margin-bottom: 1rem; /* Consistent paragraph spacing */
        }

        a {
             color: var(--link-color-light);
             text-decoration: none;
             transition: color 0.2s ease;
        }
        a:hover {
             color: var(--accent-color);
             text-decoration: underline;
        }
        body[data-theme='dark'] a {
            color: var(--link-color-dark);
        }
         body[data-theme='dark'] a:hover {
             color: var(--accent-color); /* Keep hover color consistent */
         }

        /* Buttons */
        button {
            padding: 12px 25px; /* Slightly larger padding */
            background-color: var(--secondary-color);
            color: var(--primary-color);
            border: none;
            border-radius: 8px; /* Softer corners */
            cursor: pointer;
            font-weight: 600; /* Bolder text */
            font-size: 1em;
            transition: background-color 0.2s ease, transform 0.1s ease, box-shadow 0.2s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        button:hover {
             background-color: var(--accent-color);
             transform: translateY(-2px); /* Subtle lift */
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.15);
        }
        button:active {
             transform: translateY(0);
             box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }
        body[data-theme='dark'] button {
             color: var(--primary-darker); /* Darker text on orange for contrast */
             background-color: var(--secondary-color);
             box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }
         body[data-theme='dark'] button:hover {
             background-color: var(--accent-color);
             box-shadow: 0 4px 8px rgba(0, 0, 0, 0.3);
         }
         button:disabled {
            background-color: #ccc;
            color: #888;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
         }
         body[data-theme='dark'] button:disabled {
            background-color: #555;
            color: #aaa;
         }

        /* Forms */
        input[type="text"], input[type="number"], input[type="email"], textarea, select {
            padding: 12px 15px; /* Increased padding */
            border: 1px solid var(--border-light);
            border-radius: 8px; /* Softer corners */
            font-size: 1em;
            width: 100%;
            box-sizing: border-box;
            margin-bottom: 15px; /* Increased spacing */
            background-color: var(--input-bg-light);
            color: var(--input-text-light);
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
        input[type="text"]:focus, input[type="number"]:focus, input[type="email"]:focus, textarea:focus, select:focus {
            outline: none;
            border-color: var(--secondary-color);
            box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.2); /* Orange glow on focus */
        }
        body[data-theme='dark'] input[type="text"],
        body[data-theme='dark'] input[type="number"],
        body[data-theme='dark'] input[type="email"],
        body[data-theme='dark'] textarea,
        body[data-theme='dark'] select {
            background-color: var(--input-bg-dark);
            color: var(--input-text-dark);
            border-color: var(--border-dark);
        }
         body[data-theme='dark'] input[type="text"]:focus,
         body[data-theme='dark'] input[type="number"]:focus,
         body[data-theme='dark'] input[type="email"]:focus,
         body[data-theme='dark'] textarea:focus,
         body[data-theme='dark'] select:focus {
             border-color: var(--secondary-color);
             box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.3);
         }

        .text-center {
            text-align: center;
        }

        /* --- Header --- */
        header {
            background-color: var(--primary-color);
            padding: 10px 0; /* Slightly reduced padding */
            position: sticky;
            top: 0;
            z-index: 1000; /* <<<<< Header z-index (base) */
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
        }

        .header-container {
            display: flex;
            justify-content: space-between;
            align-items: center;
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px; /* Match container padding */
        }

        .logo img {
            height: 50px; /* Slightly larger logo */
            vertical-align: middle;
        }

        #menu-toggle {
            display: none;
            padding: 10px 14px;
            background-color: var(--secondary-color);
            color: var(--primary-darker); /* Darker text */
            border: none;
            cursor: pointer;
            font-size: 1.3em;
            border-radius: 8px;
            box-shadow: none; /* Remove shadow from toggle */
        }
        body[data-theme='dark'] #menu-toggle {
            color: var(--primary-darker);
        }

        nav {
            display: block;
        }
        nav ul {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            gap: 20px; /* More space between links */
        }
        nav li {
            display: inline-block;
        }
        nav a {
            display: block;
            padding: 10px 8px;
            text-decoration: none;
            color: white;
            font-weight: 500; /* Medium weight */
            font-size: 1em;
            border-radius: 6px; /* Slightly softer radius */
            transition: background-color 0.2s ease, color 0.2s ease;
        }
        nav a:hover {
            background-color: rgba(255, 255, 255, 0.15);
            text-decoration: none;
            color: white; /* Ensure text stays white */
        }
        nav a.active { /* Style for active link (needs JS) */
            color: var(--secondary-color);
            font-weight: 600;
        }

        /* Mobile Menu Styles */
        @media (max-width: 992px) {
            #menu-toggle { display: inline-block; }
            nav {
                position: absolute;
                right: 15px; /* Align with container padding */
                top: calc(100% + 5px); /* Position below header */
                background-color: var(--background-light);
                border: 1px solid var(--border-light);
                box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
                width: 280px;
                max-height: calc(100vh - 80px);
                overflow-y: auto;
                z-index: 999; /* Below sticky header */
                display: none;
                border-radius: 8px; /* Rounded corners */
                padding: 10px 0; /* Padding top/bottom */
            }
             body[data-theme='dark'] nav {
                 background-color: var(--card-bg-dark); /* Use card background */
                 border-color: var(--border-dark);
                 box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
             }
            nav.visible { display: block; }
            nav ul { display: block; width: 100%; gap: 0; }
            nav li { display: block; border-bottom: 1px solid var(--border-light); }
            body[data-theme='dark'] nav li { border-bottom-color: var(--border-dark); }
            nav li:last-child { border-bottom: none; }
            nav a {
                padding: 15px 25px;
                color: var(--text-light);
                font-size: 1.1em;
                width: 100%;
                box-sizing: border-box;
                border-radius: 0; /* No radius inside menu */
            }
            nav a:hover {
                background-color: var(--container-bg-light);
                color: var(--primary-color);
            }
            body[data-theme='dark'] nav a { color: var(--text-dark); }
            body[data-theme='dark'] nav a:hover {
                 background-color: var(--input-bg-dark); /* Use input background for hover */
                 color: var(--secondary-color);
            }
        }

        /* --- Section Accueil --- */
        #accueil {
            position: relative;
            color: white;
            text-align: center;
            overflow: hidden;
            margin-bottom: 0; /* Remove bottom margin, handled by search bar overlap */
            min-height: 60vh; /* Ensure minimum height */
            display: flex; /* Use flex for vertical centering if needed */
            align-items: center;
        }
        #accueil .accueil-container {
            padding: 0; /* No padding on the direct container */
            position: static; /* Remove relative positioning here */
            width: 100%;
        }
        .image-accueil {
            position: absolute; /* Position background image absolutely */
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: cover;
            filter: brightness(55%) contrast(1.1); /* Darker and slightly more contrast */
            z-index: -1; /* Behind the text */
        }
        .accueil-text {
            position: relative; /* Keep relative for z-index */
            z-index: 1;
            width: 90%;
            max-width: 750px; /* Slightly wider */
            padding: 30px 40px; /* More padding */
            background-color: rgba(0, 0, 0, 0.4); /* Slightly less transparent */
            border-radius: 12px; /* Softer radius */
            margin: 50px auto; /* Center horizontally and add top/bottom margin */
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.2);
        }
        .accueil-text h2 {
            font-size: 2.8em; /* Larger title */
            margin-bottom: 15px;
            color: white;
            text-shadow: 1px 1px 3px rgba(0, 0, 0, 0.5); /* Subtle text shadow */
            font-weight: 700; /* Bolder */
        }
        .accueil-text p {
            font-size: 1.2em; /* Larger paragraph text */
            color: #f0f0f0;
            line-height: 1.7;
        }

        /* --- Section Recherche --- */
        #recherche-logement {
          position: relative; /* Keep relative */
          margin-top: -80px; /* Increased overlap */
          margin-bottom: 40px; /* Space below search bar before results */
          left: 50%;
          transform: translateX(-50%);
          width: 90%;
          max-width: 850px; /* Wider search bar */
          background: linear-gradient(135deg, var(--primary-color), var(--primary-darker)); /* Subtle gradient */
          color: white;
          padding: 30px 35px; /* More padding */
          border-radius: 16px; /* Softer radius */
          box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
          text-align: center;
          z-index: 5; /* <<<<< Above accueil image, below header */
        }
        body[data-theme='dark'] #recherche-logement {
             background: linear-gradient(135deg, var(--primary-darker), #001a33); /* Darker gradient */
             box-shadow: 0 8px 25px rgba(0, 0, 0, 0.4);
        }
        #recherche-logement .recherche-container { /* Keep these styles for inner container */
            max-width: 100%;
            padding: 0;
            background-color: transparent;
            border-radius: 0;
            color: white;
        }
        #recherche-logement h2 {
            font-size: 1.8em;
            color: white;
            margin-bottom: 25px; /* Increased space */
        }
        .choix-recherche {
            margin-bottom: 25px;
            text-align: center;
        }
        .choix-recherche label {
            margin-right: 10px;
            font-weight: 500;
            color: #eee; /* Lighter label color */
        }
        .choix-recherche select {
            padding: 10px 15px;
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 8px;
            font-size: 1em;
            background-color: rgba(255, 255, 255, 0.1); /* Transparent background */
            color: white;
            min-width: 180px;
            cursor: pointer;
        }
        .choix-recherche select option {
             background-color: var(--background-light); /* Options background */
             color: var(--text-light);
        }
        body[data-theme='dark'] .choix-recherche select {
             border-color: rgba(255, 255, 255, 0.2);
             background-color: rgba(0, 0, 0, 0.2);
        }
         body[data-theme='dark'] .choix-recherche select option {
              background-color: var(--input-bg-dark);
              color: var(--text-dark);
         }

        #form-recherche {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); /* Slightly wider min */
            gap: 20px; /* More gap */
            margin-bottom: 25px;
            align-items: end;
        }
        #form-recherche label {
            margin-bottom: 8px; /* More space */
            font-weight: 500;
            color: #eee;
            text-align: left;
            display: block;
            font-size: 0.95em; /* Slightly smaller label */
        }
        #form-recherche input[type="number"],
        #form-recherche input[type="text"] {
            margin-bottom: 0;
            padding: 12px 15px;
            background-color: rgba(255, 255, 255, 0.95); /* Slightly more opaque */
            color: #333;
            border: 1px solid transparent; /* Remove border, rely on background */
            border-radius: 8px;
        }
         #form-recherche input[type="number"]:focus,
         #form-recherche input[type="text"]:focus {
             box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.3); /* Focus glow */
             border-color: transparent; /* Keep border transparent */
         }

        #form-recherche button[type="submit"] {
            padding: 12px 30px;
            background-color: var(--secondary-color);
            color: var(--primary-darker);
            border: none;
            border-radius: 8px;
            cursor: pointer;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.15);
            grid-column: 1 / -1;
            justify-self: center;
            width: auto;
            min-width: 200px; /* Wider button */
            font-size: 1.1em;
            margin-top: 10px; /* Space above button */
        }
         #form-recherche button[type="submit"]:hover {
             background-color: var(--accent-color);
         }
         body[data-theme='dark'] #form-recherche button[type="submit"] {
             color: var(--primary-darker);
             box-shadow: 0 3px 8px rgba(0, 0, 0, 0.3);
         }
         /* Dynamic fields styling */
         #champs-logements, #champs-biens {
             display: none;
             grid-column: 1 / -1;
              /* Wrapper div inside grid needs content */
             & > div { margin-bottom: 0; } /* Remove extra margin if wrapped */
         }
         #champs-logements.visible, #champs-biens.visible {
             display: contents; /* Make children direct grid items */
         }


        /* --- Résultats de recherche --- */
        #resultats-recherche {
            margin-top: 40px; /* Space above results */
            padding: 0; /* Remove padding, container handles it */
            background-color: transparent; /* Results inherit container background */
            border-radius: 0;
            color: var(--text-light);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); /* Larger min width */
            grid-gap: 30px; /* More space */
            min-height: 150px;
        }
        body[data-theme='dark'] #resultats-recherche {
             color: var(--text-dark);
        }
         #resultats-recherche p:only-child { /* Style for "No results" message */
            grid-column: 1 / -1;
            text-align: center;
            font-style: italic;
            color: #888;
             margin-top: 30px;
             font-size: 1.1em;
         }

        /* --- Styles Communs Cards (Logement/Bien/Témoignage) --- */
        .logement,
        .bien,
        .temoignage {
            border: 1px solid var(--border-light);
            background-color: var(--card-bg-light);
            border-radius: 12px; /* Softer radius */
            box-shadow: var(--shadow-light);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            transition: transform 0.25s ease, box-shadow 0.25s ease;
            color: var(--text-light);
        }
         body[data-theme='dark'] .logement,
         body[data-theme='dark'] .bien,
         body[data-theme='dark'] .temoignage {
             border-color: var(--border-dark);
             background-color: var(--card-bg-dark);
             color: var(--text-dark);
             box-shadow: var(--shadow-dark);
         }

         .logement:hover,
         .bien:hover,
         .temoignage:hover {
             transform: translateY(-6px); /* Slightly more lift */
             box-shadow: var(--shadow-hover-light);
         }
          body[data-theme='dark'] .logement:hover,
          body[data-theme='dark'] .bien:hover,
          body[data-theme='dark'] .temoignage:hover {
             box-shadow: var(--shadow-hover-dark);
          }

        /* Images in Cards */
        .logement img,
        .bien img {
            width: 100%;
            height: 220px; /* Slightly taller image */
            object-fit: cover;
            border-bottom: 1px solid var(--border-light); /* Subtle separator */
        }
         body[data-theme='dark'] .logement img,
         body[data-theme='dark'] .bien img {
             border-bottom-color: var(--border-dark);
         }

        /* Content within Cards */
        .logement > div, .bien > div, /* Container for text */
        .temoignage > div {
             padding: 20px; /* More padding inside */
             flex-grow: 1; /* Allow text area to grow */
             display: flex;
             flex-direction: column;
        }

         .logement > h3, .bien > h3 { /* Use direct child selector if no div */
             font-size: 1.3em; /* Larger title */
             margin: 20px 20px 10px 20px; /* Adjust margin if no div */
             color: var(--primary-color);
             font-weight: 600;
         }
         body[data-theme='dark'] .logement > h3,
         body[data-theme='dark'] .bien > h3 {
             color: var(--secondary-color);
         }

         /* Paragraphs inside the text container */
         .logement > div p, .bien > div p, .temoignage > div p {
             font-size: 0.95em;
             line-height: 1.5;
             color: #555;
             margin-bottom: 8px;
         }
         body[data-theme='dark'] .logement > div p,
         body[data-theme='dark'] .bien > div p,
         body[data-theme='dark'] .temoignage > div p {
             color: #bbb;
         }

         /* Price styling */
         .logement .prix, .bien .prix { /* Add a specific class for price if possible */
             font-weight: 700; /* Bolder price */
             color: var(--primary-color);
             font-size: 1.2em;
             margin-top: 10px; /* Space above price */
             margin-bottom: 5px;
         }
         body[data-theme='dark'] .logement .prix,
         body[data-theme='dark'] .bien .prix {
             color: var(--secondary-color);
         }

         /* Location styling */
         .logement .localisation, .bien .localisation {
              font-size: 0.9em;
              color: #777;
              margin-bottom: 15px; /* Space below location */
         }
          body[data-theme='dark'] .logement .localisation,
          body[data-theme='dark'] .bien .localisation {
              color: #aaa;
          }
          .logement .localisation i, .bien .localisation i {
              margin-right: 5px; /* Space after icon */
              color: var(--secondary-color);
          }
          body[data-theme='dark'] .logement .localisation i,
          body[data-theme='dark'] .bien .localisation i {
               color: var(--secondary-color); /* Keep orange for icon */
          }

        /* Button inside cards */
        .logement button,
        .bien button {
            margin: 0 20px 20px 20px; /* Consistent margins */
            margin-top: auto; /* Push button to bottom */
            padding: 10px 20px; /* Standard button padding */
            width: calc(100% - 40px); /* Adjust width based on padding */
            align-self: stretch; /* Make button full width (minus padding) */
        }
         body[data-theme='dark'] .logement button,
         body[data-theme='dark'] .bien button {
             color: var(--primary-darker); /* Consistent button text color */
         }

        /* --- Section Dernières Publications --- */
        #derniere-publication {
            margin-top: 60px; /* More space above */
            margin-bottom: 40px;
            padding: 40px 0; /* Vertical padding, horizontal handled by container */
            background-color: var(--container-bg-light);
            border-top: 1px solid var(--border-light); /* Subtle separator */
            border-bottom: 1px solid var(--border-light);
        }
         body[data-theme='dark'] #derniere-publication {
              background-color: var(--container-bg-dark);
              border-color: var(--border-dark);
         }
        #derniere-publication .container > div { /* Target the inner div containing h2 and carousel */
            padding: 0; /* Reset padding if needed */
        }
        #derniere-publication h2 {
             margin-bottom: 30px;
        }
        #derniers-logements {
            margin-bottom: 30px; /* Space before "Voir plus" */
            width: 100%;
            min-height: 450px; /* Ensure space for cards */
            position: relative;
            overflow: hidden; /* Important for carousel items */
        }
        .logement-carousel {
            display: flex;
            transition: transform 0.5s ease-in-out;
            position: relative; /* Needed for absolute children if that logic is used */
            width: 100%; /* Initial width, JS will adjust based on slide count */
            left: 0; /* Start at the beginning */
        }

         /* --- Carousel Items (Mobile First) --- */
         /* Default: Mobile (1 slide visible) */
         #derniers-logements .logement,
         #derniers-logements .bien {
             flex: 0 0 100%; /* Each item takes full container width */
             max-width: 100%;
             box-sizing: border-box;
             padding: 0 10px; /* Padding for mobile */
             opacity: 1;
             transform: none;
             margin: 0;
             transition: opacity 0.5s ease, transform 0.5s ease;
             /* Ensure items don't shrink below their basis */
             flex-shrink: 0;
         }

         /* Tablet/Desktop (>= 769px): 3 slides visible */
         @media (min-width: 769px) {
             #derniers-logements .logement,
             #derniers-logements .bien {
                 flex-basis: calc(100% / 3); /* Width for 3 items */
                 max-width: calc(100% / 3);
                 padding: 0 15px; /* Padding for desktop */
             }
         }

        #voir-plus {
            display: block;
            margin: 20px auto;
            width: fit-content;
        }

        /* --- Sections (Services, A Propos, Comment, Admin, Temoignages) --- */
        #services, #apropos, #comment-fonctionne, #espace-administrateurs, #temoignages {
            padding: 60px 15px; /* More vertical padding */
            margin-bottom: 0; /* Remove bottom margin */
            /* Alternate background colors for visual rhythm */
        }
         #services, #espace-administrateurs, #apropos {
            background-color: var(--background-light); /* White background */
         }
         #comment-fonctionne, #temoignages {
            background-color: var(--container-bg-light); /* Off-white background */
         }

         body[data-theme='dark'] #services,
         body[data-theme='dark'] #espace-administrateurs,
         body[data-theme='dark'] #apropos {
             background-color: var(--background-dark);
         }
         body[data-theme='dark'] #comment-fonctionne,
         body[data-theme='dark'] #temoignages {
             background-color: var(--container-bg-dark);
         }


         #services h2, #apropos h2, #comment-fonctionne h2, #espace-administrateurs h2, #temoignages h2 {
             margin-bottom: 40px; /* More space below titles */
         }

        /* Services List */
        #services ul {
            list-style: none;
            padding: 0;
            margin: 0 auto;
            max-width: 700px;
            text-align: left;
        }
        #services li {
            margin-bottom: 18px;
            font-size: 1.1em;
            padding-left: 35px; /* More space for icon */
            position: relative;
            line-height: 1.5;
        }
        #services li::before {
            content: "\f00c"; /* Font Awesome check */
            font-family: "Font Awesome 5 Free"; /* Font Awesome family */
            font-weight: 900;
            display: inline-flex; /* Use flex for centering */
            align-items: center;
            justify-content: center;
            width: 24px; /* Icon container size */
            height: 24px;
            background-color: rgba(255, 165, 0, 0.15); /* Light orange background */
            color: var(--secondary-color);
            border-radius: 50%; /* Circular background */
            position: absolute;
            left: 0;
            top: 1px; /* Adjust vertical alignment */
            font-size: 0.8em; /* Slightly smaller icon */
        }
         body[data-theme='dark'] #services li::before {
             background-color: rgba(255, 165, 0, 0.2);
         }

        /* --- Section Comment ça Marche --- */
        #comment-fonctionne .container > div { /* Target inner container if nested */
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
             gap: 30px; /* More gap */
             padding: 0;
        }
        #comment-fonctionne h2 { grid-column: 1 / -1; }
        #comment-fonctionne .comment-ca-marche-item {
            text-align: center;
            padding: 30px 25px; /* More padding */
            background-color: var(--card-bg-light); /* Use card background */
            border-radius: 12px; /* Match card radius */
            box-shadow: var(--shadow-light);
            border: 1px solid var(--border-light);
             transition: transform 0.2s ease, box-shadow 0.2s ease;
        }
         #comment-fonctionne .comment-ca-marche-item:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-hover-light);
         }
        body[data-theme='dark'] #comment-fonctionne .comment-ca-marche-item {
             background-color: var(--card-bg-dark);
             border-color: var(--border-dark);
             box-shadow: var(--shadow-dark);
        }
         body[data-theme='dark'] #comment-fonctionne .comment-ca-marche-item:hover {
            box-shadow: var(--shadow-hover-dark);
         }
        #comment-fonctionne .comment-ca-marche-item i {
            font-size: 2.5em; /* Good size */
            color: var(--primary-color);
            margin-bottom: 20px;
             /* Optional: Add background circle */
             width: 70px;
             height: 70px;
             border-radius: 50%;
             background-color: rgba(0, 51, 102, 0.08); /* Light blue background */
             display: inline-flex;
             align-items: center;
             justify-content: center;
        }
        body[data-theme='dark'] #comment-fonctionne .comment-ca-marche-item i {
            color: var(--secondary-color);
            background-color: rgba(255, 165, 0, 0.1); /* Light orange background */
        }
        #comment-fonctionne .comment-ca-marche-item h4 {
            font-size: 1.25em; /* Slightly larger title */
            color: var(--primary-color);
            margin-bottom: 10px;
            font-weight: 600;
        }
         body[data-theme='dark'] #comment-fonctionne .comment-ca-marche-item h4 {
            color: var(--secondary-color);
        }
        #comment-fonctionne .comment-ca-marche-item p {
            font-size: 0.95em;
            color: #555;
            line-height: 1.6;
        }
         body[data-theme='dark'] #comment-fonctionne .comment-ca-marche-item p {
            color: #bbb;
        }

        /* --- Section Espace Administrateurs --- */
        #espace-administrateurs .container > div { text-align: center; }
        #espace-administrateurs p {
            font-size: 1.1em;
            margin-bottom: 20px;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
             color: #555;
        }
         body[data-theme='dark'] #espace-administrateurs p { color: #bbb; }
        #admin-login-button { margin-top: 25px; }

        /* --- Section Témoignages --- */
        .temoignages-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); /* Wider min width */
            gap: 30px;
            margin-bottom: 50px; /* More space before add form */
        }
        .temoignage { /* Inherits base card style */
            padding: 0; /* Remove padding, handled by inner div */
        }
         /* Use the inner div for padding */
        .temoignage > div {
             padding: 25px 30px; /* More padding */
             position: relative; /* For quote icon */
        }
        .temoignage p:first-child { /* The quote text */
            font-style: italic;
            color: #555;
            margin-bottom: 20px;
            flex-grow: 1;
            font-size: 1em;
            padding-left: 35px; /* Space for quote icon */
             position: relative;
        }
         .temoignage p:first-child::before {
             content: "\f10d"; /* left quote */
             font-family: "Font Awesome 5 Free";
             font-weight: 900;
             position: absolute;
             left: 0;
             top: -5px;
             font-size: 1.5em;
             color: var(--secondary-color);
             opacity: 0.5;
         }
        body[data-theme='dark'] .temoignage p:first-child { color: #bbb; }
         body[data-theme='dark'] .temoignage p:first-child::before {
             color: var(--secondary-color); /* Keep orange */
         }

        .temoignage-auteur {
            font-weight: 600; /* Bolder author */
            color: var(--primary-color);
            text-align: right;
            font-size: 0.95em;
            margin-top: auto; /* Push to bottom */
            padding-top: 15px;
             border-top: 1px dashed var(--border-light); /* Separator */
        }
         body[data-theme='dark'] .temoignage-auteur {
            color: var(--secondary-color);
            border-top-color: var(--border-dark);
        }

        /* Formulaire d'ajout d'avis */
        #ajout-avis {
            margin-top: 40px;
            padding: 30px 35px;
            background-color: var(--container-bg-light); /* Match section bg */
            border: 1px solid var(--border-light);
            border-radius: 12px;
            max-width: 750px;
            margin-left: auto;
            margin-right: auto;
            box-shadow: var(--shadow-light);
        }
        body[data-theme='dark'] #ajout-avis {
             background-color: var(--card-bg-dark); /* Use card bg in dark mode */
             border-color: var(--border-dark);
             box-shadow: var(--shadow-dark);
        }
        #ajout-avis h3 {
            text-align: center;
            margin-bottom: 25px;
            color: var(--primary-color);
            font-size: 1.5em;
             font-weight: 600;
        }
         body[data-theme='dark'] #ajout-avis h3 { color: var(--secondary-color); }
        #ajout-avis textarea { min-height: 120px; margin-bottom: 15px; }
        #ajout-avis input[type="text"],
        #ajout-avis input[type="email"] { margin-bottom: 15px; }
        #ajout-avis .input-group {
            display: grid;
            grid-template-columns: 1fr;
            gap: 15px;
             margin-bottom: 0; /* Remove bottom margin from group */
        }
        @media (min-width: 576px) {
             #ajout-avis .input-group { grid-template-columns: 1fr 1fr; }
             #ajout-avis input[type="text"], #ajout-avis input[type="email"] { margin-bottom: 0; } /* Remove margin when side-by-side */
        }
        #ajout-avis button[type="submit"] {
            display: block;
            margin: 25px auto 0;
            width: auto;
            min-width: 180px;
        }

        /* --- Footer --- */
        footer {
            background-color: var(--primary-darker); /* Darker blue */
            padding: 50px 0; /* More padding */
            color: #e0e0e0; /* Lighter text */
            margin-top: 60px;
             font-size: 0.95em;
        }
        .footer-content {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 15px;
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
             gap: 40px; /* Increased gap */
             text-align: left;
        }
        footer h2 { /* Footer section titles */
             color: var(--secondary-color);
             margin-bottom: 20px;
             font-size: 1.4em;
             font-weight: 600;
             text-align: left; /* Left align footer titles */
        }
        footer p {
             font-size: 1em;
             margin-bottom: 12px;
             color: #cccccc; /* Slightly dimmer text */
             line-height: 1.7;
        }
        footer ul {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        footer li {
            margin-bottom: 10px;
        }
        footer a {
            color: #ffffff; /* White links in footer */
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            transition: color 0.2s ease;
        }
        footer a:hover {
             color: var(--secondary-color);
             text-decoration: none; /* No underline on hover */
        }
        footer i { /* Icons in contact/links */
            margin-right: 12px;
            font-size: 1.3em; /* Larger icons */
            width: 25px;
            text-align: center;
             color: var(--secondary-color); /* Orange icons */
        }
         /* Newsletter form */
         #newsletter-form input[type="email"] {
             background-color: rgba(255, 255, 255, 0.1);
             border: 1px solid rgba(255, 255, 255, 0.3);
             color: white;
             margin-bottom: 10px;
             padding: 10px 15px;
             border-radius: 8px;
         }
          #newsletter-form input[type="email"]::placeholder { color: #bbb; }
          #newsletter-form input[type="email"]:focus {
             box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.3);
             border-color: var(--secondary-color);
          }
         #newsletter-form button[type="submit"] {
             width: 100%;
             padding: 10px 15px;
             font-size: 1em;
             margin-top: 5px;
         }

        .footer-content .legal-links {
            margin-top: 30px;
            grid-column: 1 / -1;
            text-align: center;
            border-top: 1px solid rgba(255, 255, 255, 0.15); /* Subtle separator */
            padding-top: 25px;
        }
        .footer-content .legal-links a {
            color: #cccccc;
            text-decoration: none;
            margin: 0 15px;
            font-size: 0.9em;
             transition: color 0.2s ease;
        }
        .footer-content .legal-links a:hover {
            color: var(--secondary-color);
            text-decoration: underline;
        }
        .footer-content > p:last-child { /* Copyright */
            margin-top: 20px;
            text-align: center;
            font-size: 0.85em;
            color: #aaaaaa;
            grid-column: 1 / -1;
        }


        /* --- Fenêtre de Détails --- */
        .fenetre-details {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: var(--card-bg-light); /* Match card background */
            border: 1px solid var(--border-light);
            padding: 30px 35px; /* More padding */
            z-index: 1020; /* <<<<< UPDATED z-index (higher than chatbot) */
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); /* Stronger shadow */
            max-width: 90%;
            width: 650px; /* Slightly wider */
            max-height: 90vh;
            overflow-y: auto;
            border-radius: 12px; /* Softer radius */
            color: var(--text-light);
        }
         body[data-theme='dark'] .fenetre-details {
             background-color: var(--card-bg-dark);
             border-color: var(--border-dark);
             color: var(--text-dark);
             box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
         }
        .fenetre-details .close-button.fenetre-close-button {
             position: absolute;
             top: 15px; /* Adjust position */
             right: 20px;
             font-size: 28px; /* Larger X */
             color: #aaa;
             cursor: pointer;
             line-height: 1;
             padding: 5px;
              transition: color 0.2s ease;
         }
          body[data-theme='dark'] .fenetre-details .close-button.fenetre-close-button { color: #888; }
         .fenetre-details .close-button.fenetre-close-button:hover { color: var(--primary-color); }
          body[data-theme='dark'] .fenetre-details .close-button.fenetre-close-button:hover { color: var(--secondary-color); }

        .fenetre-details img {
            width: 100%;
            max-height: 300px; /* Larger image */
            object-fit: cover;
            margin-bottom: 25px;
            border-radius: 8px; /* Rounded corners on image */
            border: 1px solid var(--border-light);
        }
         body[data-theme='dark'] .fenetre-details img { border-color: var(--border-dark); }
        .fenetre-details h3 {
          text-align: center;
          font-size: 1.8em; /* Larger title */
          margin-bottom: 20px;
          color: var(--primary-color);
           font-weight: 600;
        }
         body[data-theme='dark'] .fenetre-details h3 { color: var(--secondary-color); }
         .fenetre-details p {
             font-size: 1em;
             margin-bottom: 12px; /* Consistent spacing */
             line-height: 1.6;
         }
         .fenetre-details hr {
             border: none;
             border-top: 1px solid var(--border-light);
             margin: 25px 0; /* More margin around hr */
         }
          body[data-theme='dark'] .fenetre-details hr { border-top-color: var(--border-dark); }

        .fenetre-details .boutons-container {
            display: flex;
            flex-wrap: wrap;
            gap: 15px; /* More gap */
            margin-top: 25px;
            justify-content: center;
            border-top: 1px solid var(--border-light);
            padding-top: 25px;
        }
         body[data-theme='dark'] .fenetre-details .boutons-container { border-top-color: var(--border-dark); }
        .fenetre-details .boutons-container button {
           padding: 12px 20px; /* Slightly more padding */
           flex-grow: 1;
           min-width: 150px; /* Min width for buttons */
           font-size: 0.95em; /* Slightly smaller text */
           box-shadow: none; /* Remove shadow from modal buttons initially */
        }
         .fenetre-details .boutons-container button:hover {
            box-shadow: 0 3px 8px rgba(0,0,0,0.1); /* Add shadow on hover */
         }
         body[data-theme='dark'] .fenetre-details .boutons-container button:hover {
            box-shadow: 0 3px 8px rgba(0,0,0,0.2);
         }

        /* Specific Button Styles in Modal */
        .fenetre-details .bouton-infos,
        .fenetre-details .bouton-reservation,
        .fenetre-details .bouton-payer-avance {
             background-color: var(--primary-color);
             color: white;
        }
        .fenetre-details .bouton-infos:hover,
        .fenetre-details .bouton-reservation:hover,
        .fenetre-details .bouton-payer-avance:hover {
             background-color: var(--primary-darker);
        }
        body[data-theme='dark'] .fenetre-details .bouton-infos,
        body[data-theme='dark'] .fenetre-details .bouton-reservation,
        body[data-theme='dark'] .fenetre-details .bouton-payer-avance {
             background-color: var(--secondary-color);
             color: var(--primary-darker);
        }
        body[data-theme='dark'] .fenetre-details .bouton-infos:hover,
        body[data-theme='dark'] .fenetre-details .bouton-reservation:hover,
        body[data-theme='dark'] .fenetre-details .bouton-payer-avance:hover {
             background-color: var(--accent-color);
        }

        .fenetre-details .bouton-discussion { /* WhatsApp Button */
             background-color: #25D366;
             color: white;
        }
        .fenetre-details .bouton-discussion:hover { background-color: #1DAE54; }

        .fenetre-details button:disabled { /* Keep disabled style */
            background-color: #ccc;
            color: #888;
            cursor: not-allowed;
             transform: none;
             box-shadow: none;
        }
         body[data-theme='dark'] .fenetre-details button:disabled {
             background-color: #555;
             color: #aaa;
         }

        /* Info/Reservation Sections in Modal */
        .fenetre-details .reservation-info,
        .fenetre-details .infos-logement {
            margin-top: 25px;
            padding: 20px; /* More padding */
            background-color: var(--container-bg-light); /* Use container background */
            border: 1px solid var(--border-light);
            border-radius: 8px;
        }
         body[data-theme='dark'] .fenetre-details .reservation-info,
         body[data-theme='dark'] .fenetre-details .infos-logement {
             background-color: var(--container-bg-dark);
             border-color: var(--border-dark);
         }
         .fenetre-details .reservation-info h4,
         .fenetre-details .infos-logement h4 {
             margin-top: 0;
             margin-bottom: 15px; /* More space */
             color: var(--primary-color);
             font-size: 1.2em;
             font-weight: 600;
         }
          body[data-theme='dark'] .fenetre-details .reservation-info h4,
          body[data-theme='dark'] .fenetre-details .infos-logement h4 {
              color: var(--secondary-color);
          }
          .fenetre-details .reservation-info ul {
              margin-left: 20px;
              margin-bottom: 15px;
               list-style: disc; /* Use disc for clarity */
          }
           .fenetre-details .reservation-info li {
               margin-bottom: 8px;
               font-size: 0.95em;
           }
           .fenetre-details .infos-logement p {
                margin-bottom: 8px;
                font-size: 0.95em;
           }


        /* --- Modales (Termes & Confidentialité) --- */
        .modal {
            display: none;
            position: fixed;
            z-index: 1025; /* <<<<< UPDATED z-index (highest) */
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.7); /* Darker overlay */
        }
        .modal-content {
            background-color: var(--modal-bg-light);
            color: var(--text-light);
            margin: 8% auto; /* Adjust vertical margin */
            padding: 35px 40px; /* More padding */
            border: none; /* Remove border, rely on shadow */
            width: 85%;
            max-width: 800px;
            border-radius: 12px; /* Softer radius */
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            position: relative;
            max-height: 85vh;
            overflow-y: auto;
        }
         body[data-theme='dark'] .modal-content {
             background-color: var(--modal-bg-dark);
             color: var(--text-dark);
             box-shadow: 0 10px 30px rgba(0,0,0,0.4);
         }
        .modal-content .close-button {
            color: #aaa;
            position: absolute;
            top: 15px; /* Position */
            right: 20px;
            font-size: 30px; /* Larger X */
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
            transition: color 0.2s ease;
        }
        body[data-theme='dark'] .modal-content .close-button { color: #888; }
        .modal-content .close-button:hover,
        .modal-content .close-button:focus {
            color: var(--primary-color); /* Match theme color */
        }
         body[data-theme='dark'] .modal-content .close-button:hover,
         body[data-theme='dark'] .modal-content .close-button:focus {
            color: var(--secondary-color);
        }
        .modal-content h2 {
            margin-top: 0;
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 25px;
             font-size: 1.8em;
             font-weight: 600;
        }
         body[data-theme='dark'] .modal-content h2 { color: var(--secondary-color); }
        .modal-content h3 {
            color: var(--primary-color); /* Use primary */
            margin-top: 2em;
            margin-bottom: 0.8em;
            font-size: 1.3em;
             font-weight: 600;
             border-bottom: 1px solid var(--border-light);
             padding-bottom: 5px;
        }
         body[data-theme='dark'] .modal-content h3 {
            color: var(--secondary-color);
            border-bottom-color: var(--border-dark);
        }
         .modal-content h4 {
            color: #444;
            margin-top: 1.5em;
            margin-bottom: 0.5em;
            font-size: 1.1em;
             font-weight: 600;
         }
         body[data-theme='dark'] .modal-content h4 { color: #ddd; }
        .modal-content ul {
            list-style: disc;
            margin-left: 25px;
            margin-bottom: 1.5em;
        }
         .modal-content li {
            margin-bottom: 0.8em;
            line-height: 1.6;
         }
         .modal-content p {
            line-height: 1.7; /* More line height */
            margin-bottom: 1.2em;
            font-size: 1em; /* Standard size */
         }

        /* --- Indicateur de chargement --- */
        .loading {
            text-align: center;
            padding: 30px 15px; /* More padding */
            font-style: italic;
            color: #888;
            font-size: 1.1em;
        }
        body[data-theme='dark'] .loading { color: #aaa; }

        /* --- Chatbot Flottant --- */
        #chatbot-toggle {
            position: fixed;
            bottom: 25px; /* Slightly higher */
            right: 25px;
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, var(--primary-color), var(--primary-darker)); /* Gradient */
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 26px; /* Adjusted size */
            cursor: pointer;
            z-index: 1010; /* <<<<< UPDATED z-index */
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: background 0.3s ease, transform 0.2s ease;
        }
        #chatbot-toggle:hover {
             background: linear-gradient(135deg, var(--primary-darker), var(--primary-color));
             transform: scale(1.1); /* Scale up on hover */
        }
        body[data-theme='dark'] #chatbot-toggle {
            background: linear-gradient(135deg, var(--secondary-color), var(--accent-color));
            color: var(--primary-darker);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.4);
        }
         body[data-theme='dark'] #chatbot-toggle:hover {
            background: linear-gradient(135deg, var(--accent-color), var(--secondary-color));
         }

        .chatbot-window {
            position: fixed;
            bottom: 100px; /* Above toggle */
            right: 25px;
            width: 370px; /* Slightly wider */
            height: 580px; /* Taller */
            background-color: var(--background-light);
            border: 1px solid var(--border-light);
            border-radius: 15px; /* Softer radius */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            z-index: 1015; /* <<<<< UPDATED z-index (higher than header) */
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        .chatbot-window.visible { display: flex; }
        body[data-theme='dark'] .chatbot-window {
            background-color: var(--card-bg-dark); /* Use card bg */
            border-color: var(--border-dark);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .chatbot-header {
            padding: 12px 20px; /* More padding */
            background-color: var(--primary-color);
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-top-left-radius: 15px; /* Match window radius */
            border-top-right-radius: 15px;
            flex-shrink: 0;
        }
         body[data-theme='dark'] .chatbot-header { background-color: var(--primary-darker); }
        .chatbot-header h4 {
            margin: 0;
            font-size: 1.15em; /* Slightly larger title */
            font-weight: 600;
        }
        #chatbot-close {
            cursor: pointer;
            font-size: 24px; /* Larger close */
            background: none;
            border: none;
            color: rgba(255, 255, 255, 0.7);
            padding: 0 5px;
             transition: color 0.2s ease;
        }
         #chatbot-close:hover { color: white; }

        #chatbot-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 20px; /* More padding */
            display: flex;
            flex-direction: column;
            gap: 12px;
             scrollbar-width: thin; /* Firefox scrollbar */
             scrollbar-color: #ccc var(--background-light); /* Firefox scrollbar */
        }
         #chatbot-messages::-webkit-scrollbar { width: 6px; } /* Webkit scrollbar */
         #chatbot-messages::-webkit-scrollbar-track { background: var(--background-light); }
         #chatbot-messages::-webkit-scrollbar-thumb { background-color: #ccc; border-radius: 3px; }

         body[data-theme='dark'] #chatbot-messages {
             scrollbar-color: #555 var(--card-bg-dark);
         }
          body[data-theme='dark'] #chatbot-messages::-webkit-scrollbar-track { background: var(--card-bg-dark); }
          body[data-theme='dark'] #chatbot-messages::-webkit-scrollbar-thumb { background-color: #555; }

        /* Chat messages */
        .chatbot-window .message {
            padding: 10px 15px; /* More padding */
            border-radius: 18px; /* More rounded */
            max-width: 85%; /* Slightly wider max */
            word-wrap: break-word;
            line-height: 1.5;
            clear: both;
            font-size: 0.95em; /* Slightly smaller text */
        }
        .chatbot-window .user-message {
            background-color: var(--primary-color); /* User messages in primary blue */
            color: white;
            align-self: flex-end;
            border-bottom-right-radius: 6px;
        }
        .chatbot-window .ai-message {
            background-color: var(--container-bg-light); /* AI messages in off-white */
            color: var(--text-light);
            align-self: flex-start;
            border: 1px solid var(--border-light);
            border-bottom-left-radius: 6px;
        }
         body[data-theme='dark'] .chatbot-window .user-message {
             background-color: var(--secondary-color); /* User messages orange */
             color: var(--primary-darker);
         }
          body[data-theme='dark'] .chatbot-window .ai-message {
              background-color: var(--input-bg-dark); /* AI messages dark input bg */
              color: var(--text-dark);
              border-color: var(--border-dark);
          }
           /* Typing indicator dots */
           .chatbot-window .typing-indicator span { background-color: #aaa; }
            body[data-theme='dark'] .chatbot-window .typing-indicator span { background-color: #777; }

        .chatbot-input-area {
            padding: 15px; /* More padding */
            border-top: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 10px; /* More gap */
            flex-shrink: 0;
            background-color: var(--background-light); /* Ensure background match */
        }
         body[data-theme='dark'] .chatbot-input-area {
             border-top-color: var(--border-dark);
             background-color: var(--card-bg-dark);
         }

        #chatbot-input {
            flex-grow: 1;
            resize: none;
            border: 1px solid var(--border-light);
            border-radius: 25px; /* Fully rounded */
            padding: 10px 18px; /* More padding */
            max-height: 100px; /* Increased max height */
            overflow-y: auto;
            font-size: 1em; /* Standard font size */
             background-color: var(--input-bg-light);
             color: var(--input-text-light);
              transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }
         #chatbot-input:focus {
             outline: none;
             border-color: var(--secondary-color);
             box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.2);
         }
        body[data-theme='dark'] #chatbot-input {
             background-color: var(--input-bg-dark);
             color: var(--input-text-dark);
             border-color: var(--border-dark);
        }
         body[data-theme='dark'] #chatbot-input:focus {
             border-color: var(--secondary-color);
             box-shadow: 0 0 0 3px rgba(255, 165, 0, 0.3);
         }

        #chatbot-send {
            padding: 0; /* Remove padding, use width/height */
            background-color: var(--secondary-color);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            color: var(--primary-darker);
            width: 44px; /* Slightly larger button */
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
             transition: background-color 0.2s ease;
        }
         #chatbot-send:hover { background-color: var(--accent-color); }
        #chatbot-send i { font-size: 1.2em; /* Larger icon */ }
        body[data-theme='dark'] #chatbot-send { color: var(--primary-darker); }


        /* --- Responsive Adjustments --- */
        @media (max-width: 768px) { /* Adjusted breakpoint to match JS */
            body { font-size: 15px; } /* Slightly smaller base on mobile */
            h2 { font-size: 1.8em; margin-bottom: 25px;}
            .container { padding: 15px 10px; }

            #accueil { min-height: 50vh; }
            .image-accueil { }
            .accueil-text { padding: 20px; margin: 30px auto; max-width: 95%; }
            .accueil-text h2 { font-size: 2em; }
            .accueil-text p { font-size: 1em; }

            #recherche-logement {
                margin-top: -50px; /* Adjust overlap */
                padding: 20px 15px;
                border-radius: 12px;
                max-width: 95%;
            }
            #form-recherche {
                grid-template-columns: 1fr; /* Single column */
                gap: 15px;
            }
            #form-recherche button[type="submit"] { min-width: 180px; font-size: 1em; }
            #champs-logements.visible, #champs-biens.visible { display: contents; }

            #resultats-recherche { grid-template-columns: 1fr; gap: 20px; }

            /* Carousel handled by main CSS rules and @media (min-width: 769px) */

            #services, #apropos, #comment-fonctionne, #espace-administrateurs, #temoignages { padding: 40px 10px; }
            #comment-fonctionne .container > div { grid-template-columns: 1fr; gap: 20px; }
            #comment-fonctionne .comment-ca-marche-item { padding: 25px 20px; }

            .temoignages-container { grid-template-columns: 1fr; gap: 20px; }
            #ajout-avis { padding: 25px 20px; max-width: 95%; }
             #ajout-avis .input-group { grid-template-columns: 1fr; } /* Force single column */
             #ajout-avis input[type="text"], #ajout-avis input[type="email"] { margin-bottom: 15px; } /* Restore margin */


            footer { padding: 40px 0; }
            .footer-content { grid-template-columns: 1fr; text-align: center; gap: 30px; }
            footer h2 { text-align: center; }
            #contact ul { justify-content: center; display: flex; flex-direction: column; align-items: center; }
             #contact li { display: flex; justify-content: center; }
             #newsletter-form { max-width: 350px; margin: 0 auto; }

             .fenetre-details { width: 95%; padding: 20px; }
             .fenetre-details img { max-height: 200px; }
             .fenetre-details h3 { font-size: 1.5em; }

             .modal-content { width: 92%; margin: 10% auto; padding: 20px 15px; }

             #chatbot-toggle { width: 55px; height: 55px; font-size: 24px; bottom: 15px; right: 15px; }
             .chatbot-window { width: calc(100% - 30px); height: 70vh; bottom: 80px; right: 15px; border-radius: 12px; }
             .chatbot-header { padding: 10px 15px; }
             #chatbot-messages { padding: 15px; }
             .chatbot-input-area { padding: 10px; }
             #chatbot-input { padding: 8px 15px; }
             #chatbot-send { width: 40px; height: 40px; }
        }

        /* Keyframes for typing indicator */
        @keyframes typing {
            0%, 100% { opacity: 0.3; transform: scale(0.7); }
            50% { opacity: 1; transform: scale(1); }
        }
         /* Styling for typing indicator dots */
        .typing-indicator {
             display: flex;
             padding: 5px 0; /* Add some vertical space */
         }
        .typing-indicator span {
             height: 8px;
             width: 8px;
             background-color: #aaa; /* Base color */
             border-radius: 50%;
             display: inline-block;
             margin: 0 2px;
             animation: typing 1s infinite ease-in-out;
         }
        .typing-indicator span:nth-child(1) { animation-delay: 0.1s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.3s; }
         body[data-theme='dark'] .typing-indicator span {
             background-color: #777; /* Dark mode color */
         }


        /* --- END OF ENHANCED styles.css --- */
    </style>

</head>
<body>
    <header>
        <div class="container header-container">
            <div class="logo">
                <img src="img/logo.png" alt="ESPACE BENIN Logo">
            </div>
            <button id="menu-toggle">
                <i class="fas fa-bars"></i>
            </button>
             <nav id="main-nav">
               <ul id="menu" > <!-- Removed hidden class -->
                    <li><a href="#accueil">Accueil</a></li>
                    <li><a href="#recherche-logement">Rechercher</a></li>
                    <li><a href="#derniere-publication">Publications</a></li>
                    <li><a href="#services">Services</a></li>
                    <li><a href="#comment-fonctionne">Fonctionnement</a></li>
                    <li><a href="#espace-administrateurs">Admin</a></li>
                    <li><a href="#temoignages">Témoignages</a></li>
                    <li><a href="#apropos">Pourquoi Nous ?</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
            </nav>
        </div>
    </header>

    <main>
        <section id="accueil">
            <div class="container accueil-container">
                <img src="img/immo.jpeg" alt="Image de bienvenue" class="image-accueil">
                <div class="accueil-text">
                    <h2>Bienvenue chez ESPACE BENIN</h2>
                    <p>Votre partenaire de confiance pour la gestion immobilière au Bénin.</p>
                    <p>Trouvez, louez ou vendez facilement vos biens immobiliers avec nous.</p>
                </div>
            </div>
        </section>

        <section id="recherche-logement">
            <div class="container recherche-container">
                <h2>Que recherchez-vous ?</h2>
                <!-- Choix du type de recherche -->
                <div class="choix-recherche">
                    <label for="type-recherche">Je recherche :</label>
                    <select id="type-recherche">
                        <option value="logements">Logements</option>
                        <option value="biens">Biens Divers</option>
                    </select>
                </div>

                <!-- Formulaire de recherche -->
                <form id="form-recherche">
                   <div id="champs-communs">
                        <div>
                            <label for="budget">Budget Max (FCFA) :</label>
                            <input type="number" id="budget" name="budget" min="0" placeholder="Ex: 50000">
                        </div>
                        <div>
                            <label for="ville">Ville :</label>
                            <input type="text" id="ville" name="ville" placeholder="Ex: Cotonou">
                        </div>
                         <div>
                             <label for="quartier">Quartier / Zone :</label>
                             <input type="text" id="quartier" name="quartier" placeholder="Ex: Agla, Fidjrossè">
                         </div>
                    </div>

                    <div id="champs-logements" class="visible"> <!-- Initialement visible -->
                         <label for="type">Type de logement :</label>
                         <input type="text" id="type" name="type" placeholder="Ex: Chambre, Appartement">
                    </div>

                     <div id="champs-biens">
                        <!-- Champs spécifiques aux biens si nécessaire -->
                    </div>

                    <button type="submit">Lancer la Recherche</button>
                </form>
            </div>
            <!-- Indicateur de chargement -->
            <div id="loading-indicator" class="loading" style="display: none;">Chargement des résultats...</div>
            <!-- Zone d'affichage des résultats -->
            <div id="resultats-recherche" class="container" style="display:none;"></div>
        </section>

        <section id="derniere-publication" class="container">
            <!-- Conteneur ajouté pour centrer -->
            <div>
                <h2>Dernières publications</h2>
                <div id="derniers-logements">
                    <!-- Carousel items will be injected here -->
                     <p class="loading">Chargement des publications...</p> <!-- Message de chargement initial -->
                </div>
                <button id="voir-plus">Voir toutes les publications</button>
            </div>
        </section>

        <section id="services" class="container">
             <div>
                <h2>Nos services</h2>
                <ul>
                    <li>Location de Maisons, Appartements, Chambres</li>
                    <li>Vente et Location de Biens Divers</li>
                    <li>Gestion Locative et Immobilière</li>
                    <li>Location de Véhicules</li>
                    <li>Vente de Parcelles et Terrains</li>
                    <li>Construction et Travaux BTP</li>
                     <li>Hébergement (Hôtel, Motel)</li>
                </ul>
            </div>
        </section>

        <section id="comment-fonctionne" class="container">
             <div>
                <h2>Comment ça marche ?</h2>
                <div class="container"> <!-- Container interne pour la grille -->
                     <div class="comment-ca-marche-item">
                         <i class="fas fa-search-dollar"></i>
                         <h4>1. Définissez vos critères</h4>
                         <p>Indiquez votre budget, la ville, le quartier et le type de bien recherché.</p>
                     </div>
                     <div class="comment-ca-marche-item">
                         <i class="fas fa-list-alt"></i>
                         <h4>2. Parcourez les offres</h4>
                         <p>Consultez les résultats correspondants avec photos et descriptions détaillées.</p>
                     </div>
                     <div class="comment-ca-marche-item">
                         <i class="fas fa-calendar-check"></i>
                         <h4>3. Réservez ou contactez</h4>
                         <p>Réservez en ligne (si disponible) ou contactez directement l'agence via WhatsApp.</p>
                     </div>
                     <div class="comment-ca-marche-item">
                         <i class="fas fa-handshake"></i>
                         <h4>4. Finalisez la transaction</h4>
                         <p>Organisez une visite et finalisez la location ou l'achat en toute sécurité.</p>
                     </div>
                </div>
            </div>
        </section>

        <section id="espace-administrateurs" class="container">
            <div>
                <h2>Espace Partenaires & Propriétaires</h2>
                <p>Ajoutez et gérez facilement vos biens immobiliers sur notre plateforme.</p>
                <p>Que vous soyez une agence ou un particulier, rejoignez notre réseau pour augmenter votre visibilité.</p>
                <button id="admin-login-button">Accéder à l'Espace Admin</button>
            </div>
        </section>

       <section id="temoignages" class="container">
            <div>
                <h2>Témoignages Clients</h2>
                <div class="temoignages-container">
                    <p class="loading">Chargement des témoignages...</p>
                </div>
                <div id="ajout-avis">
                    <h3>Laissez votre avis</h3>
                    <form id="form-ajout-avis">
                        <div class="input-group">
                            <input type="text" id="avis-nom" placeholder="Votre nom *" required>
                            <input type="email" id="avis-email" placeholder="Votre email (facultatif)">
                        </div>
                        <textarea id="avis-texte" placeholder="Votre témoignage *" required></textarea>
                        <button type="submit">Soumettre l'avis</button>
                    </form>
                </div>
            </div>
        </section>

        <section id="apropos" class="container">
            <div>
                <h2>Pourquoi choisir ESPACE BENIN ?</h2>
                <p>Nous simplifions votre recherche immobilière grâce à une plateforme centralisée, facile à utiliser et sécurisée. Profitez d'un large choix de biens vérifiés et d'une mise en relation directe avec des professionnels.</p>
                <p>Gagnez du temps et trouvez le bien idéal sans tracas.</p>
            </div>
        </section>
    </main>

    <footer>
         <div class="container footer-content">
            <section id="contact">
                <h2>Contactez-nous</h2>
                <p>Besoin d'aide ou d'informations ?</p>
                <ul>
                    <li><i class="fab fa-whatsapp"></i> <a href="https://wa.me/+22951092429" target="_blank" rel="noopener noreferrer">WhatsApp (+229 51092429)</a></li>
                    <li><i class="fab fa-facebook"></i> <a href="https://www.facebook.com/profile.php?id=61559141486005" target="_blank" rel="noopener noreferrer">Facebook</a></li>
                    <li><i class="fas fa-envelope"></i> <a href="mailto:espacebenin@gmail.com">espacebenin@gmail.com</a></li>
                    <li><i class="fas fa-map-marker-alt"></i> <span>Banikanni, Parakou - Bénin</span></li>
                </ul>
            </section>
             <!-- Section Liens Rapides (Optionnel) -->
            <section>
                <h2>Liens Rapides</h2>
                 <ul>
                     <li><a href="#accueil">Accueil</a></li>
                     <li><a href="#recherche-logement">Recherche</a></li>
                     <li><a href="#services">Services</a></li>
                      <li><a href="#" id="show-terms-footer">Termes</a> / <a href="#" id="show-privacy-footer">Confidentialité</a></li>
                 </ul>
            </section>
             <!-- Section Newsletter (Optionnel) -->
             <section>
                 <h2>Newsletter</h2>
                 <p>Recevez nos dernières offres :</p>
                 <form id="newsletter-form">
                     <input type="email" placeholder="Votre email" required>
                     <button type="submit">S'inscrire</button>
                 </form>
             </section>

            <div class="legal-links">
                <a href="#" id="show-terms">Termes et Conditions</a> |
                <a href="#" id="show-privacy">Politique de Confidentialité</a>
            </div>
            <p>© 2024 ESPACE BENIN - Plateforme de gestion immobilière.</p>
        </div>
    </footer>

    <!-- Fenêtre modale pour la politique de confidentialité -->
    <div id="privacy-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span>
            <h2>POLITIQUE DE CONFIDENTIALITÉ</h2>

            <h3>1. Collecte des Informations</h3>
             <p>Nous collectons des informations lorsque vous utilisez notre site, notamment :</p>
            <ul>
                <li>Informations fournies lors de la recherche (budget, ville, quartier, type).</li>
                <li>Données de contact (nom, email, téléphone) si vous soumettez un avis ou utilisez certaines fonctionnalités.</li>
                <li>Données de navigation (cookies) pour améliorer l'expérience utilisateur et analyser le trafic.</li>
                 <li>Informations fournies par les administrateurs/partenaires lors de l'ajout de biens.</li>
            </ul>

            <h3>2. Utilisation des Données</h3>
            <p>Vos données sont utilisées pour :</p>
            <ul>
                <li>Afficher les résultats de recherche pertinents.</li>
                <li>Faciliter la mise en relation avec les agences/propriétaires (via WhatsApp, email).</li>
                 <li>Afficher les témoignages (nom et email si fourni).</li>
                <li>Améliorer notre plateforme et nos services.</li>
                <li>Communiquer avec vous (si vous vous inscrivez à la newsletter).</li>
                <li>Gérer l'espace administrateur.</li>
            </ul>
             <p>Nous ne vendons ni ne partageons vos informations personnelles avec des tiers à des fins commerciales sans votre consentement explicite, sauf si requis par la loi.</p>

             <h3>3. Sécurité et Conservation</h3>
                <p>Nous utilisons Firebase pour stocker les données, qui offre des mesures de sécurité robustes. Cependant, aucune méthode de transmission ou de stockage n'est infaillible.</p>
                <p>Vos données sont conservées aussi longtemps que nécessaire pour fournir les services ou conformément aux obligations légales.</p>

            <h3>4. Vos Droits</h3>
              <p>Vous pouvez avoir le droit de :</p>
                <ul>
                    <li>Accéder aux informations que nous détenons vous concernant (principalement les avis).</li>
                    <li>Demander la correction ou la suppression de vos avis.</li>
                    <li>Gérer vos préférences de cookies via votre navigateur.</li>
                </ul>

            <h3>5. Cookies</h3>
               <p>Nous utilisons des cookies essentiels et analytiques. Vous pouvez gérer vos préférences de cookies dans les paramètres de votre navigateur.</p>

            <h3>6. Contact</h3>
             <p>Pour toute question relative à cette politique, contactez-nous via les informations fournies dans la section Contact du site.</p>
        </div>
    </div>

    <!-- Fenêtre modale pour les termes et conditions -->
    <div id="terms-modal" class="modal">
        <div class="modal-content">
            <span class="close-button">×</span>
             <h2>CONDITIONS D'UTILISATION</h2>

             <h3>1. Acceptation des Conditions</h3>
                <p>En utilisant le site ESPACE BENIN, vous acceptez de vous conformer aux présentes Conditions d'Utilisation.</p>

             <h3>2. Description du Service</h3>
                <p>ESPACE BENIN est une plateforme en ligne visant à faciliter la recherche et la mise en relation pour la location et la vente de biens immobiliers et divers au Bénin. Nous agrégeons les offres de différentes agences et particuliers partenaires.</p>

             <h3>3. Utilisation du Site</h3>
                <ul>
                    <li>Les informations fournies sur le site (descriptions, prix, disponibilités) sont publiées par nos partenaires et sont sous leur responsabilité. ESPACE BENIN s'efforce de maintenir les informations à jour mais ne peut garantir leur exactitude absolue.</li>
                    <li>Vous utilisez le site pour rechercher des biens et contacter les partenaires via les moyens mis à disposition (WhatsApp, etc.).</li>
                    <li>Toute transaction (location, achat, réservation, paiement) se fait directement entre vous et le partenaire concerné. ESPACE BENIN n'est pas partie prenante à ces transactions et ne saurait être tenu responsable des litiges éventuels.</li>
                     <li>Les paiements de réservation ou de loyer effectués via les liens FedaPay fournis engagent directement l'utilisateur et le destinataire du paiement (agence/propriétaire).</li>
                     <li>Vous vous engagez à ne pas utiliser le site à des fins illégales ou interdites par ces conditions.</li>
                </ul>

             <h3>4. Espace Administrateur/Partenaire</h3>
                 <ul>
                    <li>L'accès à l'espace administrateur est réservé aux partenaires autorisés.</li>
                    <li>Les partenaires sont responsables de l'exactitude et de la légalité des informations qu'ils publient.</li>
                     <li>Les partenaires doivent s'assurer que les biens marqués comme "Payé" ou "Réservé" le sont effectivement et maintenir les statuts à jour.</li>
                 </ul>


             <h3>5. Témoignages</h3>
                 <ul>
                     <li>En soumettant un témoignage, vous accordez à ESPACE BENIN le droit de le publier sur le site.</li>
                     <li>Vous garantissez que votre témoignage est véridique et ne viole aucun droit de tiers.</li>
                 </ul>


             <h3>6. Limitation de Responsabilité</h3>
                <ul>
                    <li>ESPACE BENIN agit comme un intermédiaire et ne peut être tenu responsable de la qualité des biens, de l'issue des transactions, ou des actions des utilisateurs ou des partenaires.</li>
                     <li>Nous ne garantissons pas un accès ininterrompu ou sans erreur au site.</li>
                </ul>

             <h3>7. Propriété Intellectuelle</h3>
                 <p>Le contenu du site (textes, images, logo, design) est la propriété d'ESPACE BENIN ou de ses partenaires et est protégé par les lois sur la propriété intellectuelle.</p>

             <h3>8. Modifications des Conditions</h3>
                <p>Nous nous réservons le droit de modifier ces conditions à tout moment. Les modifications prendront effet dès leur publication sur le site.</p>

              <h3>9. Droit Applicable</h3>
                 <p>Ces conditions sont régies par le droit béninois.</p>
        </div>
    </div>

     <!-- Chatbot Flottant -->
     <div id="chatbot-toggle">
         <i class="fas fa-comment-dots"></i>
     </div>
     <div id="chatbot-window" class="chatbot-window">
         <div class="chatbot-header">
             <h4>Assistant IA</h4>
             <button id="chatbot-close">×</button>
         </div>
         <div id="chatbot-messages">
             <!-- Les messages du chat apparaîtront ici -->
             <div class="message ai-message">Bonjour ! Comment puis-je vous aider aujourd'hui ?</div>
         </div>
         <div class="chatbot-input-area">
             <textarea id="chatbot-input" placeholder="Posez votre question..." rows="1"></textarea>
             <button id="chatbot-send"><i class="fas fa-paper-plane"></i></button>
         </div>
     </div>


    <script>
// --- START OF COMBINED SCRIPT FOR index.html ---

// --- Section 1: ESPACE BENIN Real Estate Logic ---

// Configuration de Firebase (ESPACE BENIN)
const firebaseConfigEspaceBenin = {
    apiKey: "AIzaSyAwHqU_XLmDz9VbsxVGN3wbru3-hLDiyNI", // Clé de ESPACE BENIN
    authDomain: "microfinance-68811.firebaseapp.com",
    databaseURL: "https://microfinance-68811-default-rtdb.firebaseio.com",
    projectId: "microfinance-68811",
    storageBucket: "microfinance-68811.appspot.com",
    messagingSenderId: "328514838296",
    appId: "1:328514838296:web:89b35343ca3a14b352c86d",
    measurementId: "G-RBQJH93VWE"
};

// Initialiser Firebase pour ESPACE BENIN (avec un nom unique)
const espaceBeninApp = firebase.initializeApp(firebaseConfigEspaceBenin, "espaceBenin");
const databaseEspaceBenin = espaceBeninApp.database();

// Fonction pour afficher/cacher l'indicateur de chargement principal
function toggleLoading(show) {
    const loadingIndicator = document.getElementById("loading-indicator");
    if (loadingIndicator) {
        loadingIndicator.style.display = show ? "block" : "none";
    }
}

// Fonction de recherche générique pour ESPACE BENIN
async function effectuerRecherche(budget, quartier, ville, typeLogement) {
    toggleLoading(true);
    const resultats = {};
    const maintenant = Date.now();
    const typeRechercheSelect = document.getElementById("type-recherche");
    const typeRechercheSelectionne = typeRechercheSelect ? typeRechercheSelect.value : 'logements';

    try {
        const entreprisesSnapshot = await databaseEspaceBenin.ref('entreprises').once('value');
        const entreprisesData = entreprisesSnapshot.val();

        if (!entreprisesData) {
            console.log("Aucune entreprise trouvée dans ESPACE BENIN.");
            return {};
        }

        for (const entrepriseKey of Object.keys(entreprisesData)) {
            const entrepriseNomSnapshot = await databaseEspaceBenin.ref(`entreprises/${entrepriseKey}/nom`).once('value');
            const entrepriseNom = entrepriseNomSnapshot.val() || "Entreprise inconnue";

            const typesToSearch = typeRechercheSelectionne ? [typeRechercheSelectionne] : ['logements', 'biens'];

            for (const typeRecherche of typesToSearch) {
                const itemsRef = databaseEspaceBenin.ref(`entreprises/${entrepriseKey}/${typeRecherche}`);
                const itemsSnapshot = await itemsRef.once('value');
                const itemsData = itemsSnapshot.val();

                if (!itemsData) continue;

                for (const itemKey of Object.keys(itemsData)) {
                    const item = itemsData[itemKey];
                    if (typeof item !== 'object' || item === null || typeof item.prix === 'undefined') continue;

                    // Filtrage : Exclure les items payés il y a moins de 24h
                    let isPaidAndUnavailable = false;
                    if (item.statut === "Payé" && item.datePaiement) {
                        try {
                            const datePaiement = new Date(item.datePaiement);
                            const vingtQuatreHeures = 24 * 60 * 60 * 1000;
                            if (!isNaN(datePaiement.getTime()) && (maintenant - datePaiement.getTime() < vingtQuatreHeures)) {
                                isPaidAndUnavailable = true;
                            }
                        } catch (e) { /* Ignorer date invalide */ }
                    }
                    if (isPaidAndUnavailable) continue;

                    // Filtrage budget, quartier, ville
                    const budgetMatch = (budget === null || typeof item.prix !== 'number' || item.prix <= budget);
                    const quartierMatch = (quartier === null || !quartier || (typeof item.quartier === 'string' && item.quartier.toLowerCase().includes(quartier.toLowerCase())));
                    const villeMatch = (ville === null || !ville || (typeof item.ville === 'string' && item.ville.toLowerCase().includes(ville.toLowerCase())));

                    if (budgetMatch && quartierMatch && villeMatch) {
                        // Filtrage spécifique type de logement
                        const typeLogementMatch = !(typeRecherche === 'logements' && typeLogement !== null && typeLogement !== "" && (typeof item.type !== 'string' || !item.type.toLowerCase().includes(typeLogement.toLowerCase())));

                        if (typeLogementMatch) {
                            resultats[itemKey + '_' + typeRecherche] = { // Clé unique
                                ...item,
                                entrepriseId: entrepriseKey,
                                entrepriseNom: entrepriseNom,
                                statut: item.statut || "Non spécifié",
                                typeRecherche: typeRecherche,
                                id: itemKey
                            };
                        }
                    }
                }
            }
        }
        return resultats;
    } catch (error) {
        console.error(`Erreur lors de la récupération des données ESPACE BENIN:`, error);
        alert(`Une erreur est survenue lors de la recherche. Veuillez réessayer.`);
        return {};
    } finally {
        toggleLoading(false);
    }
}

// Fonction pour afficher les résultats de recherche ESPACE BENIN
function afficherResultatsDansLaPage(resultats) {
    const resultatsRecherche = document.getElementById("resultats-recherche");
    if (!resultatsRecherche) return;

    resultatsRecherche.innerHTML = ""; // Vider
    resultatsRecherche.style.display = "grid"; // Afficher en grille

    if (Object.keys(resultats).length === 0) {
        const messageAucunResultat = document.createElement("p");
        messageAucunResultat.textContent = "Aucun résultat ne correspond à vos critères.";
        messageAucunResultat.style.gridColumn = "1 / -1";
        messageAucunResultat.style.textAlign = "center";
        resultatsRecherche.appendChild(messageAucunResultat);
    } else {
        for (const itemId in resultats) {
            const item = resultats[itemId];
             if (typeof item === 'object' && item !== null && item.typeRecherche) {
                const divItem = item.typeRecherche === 'logements' ? creerDivLogement(item) : creerDivBien(item);
                if (divItem) {
                   resultatsRecherche.appendChild(divItem);
                }
            }
        }
    }
}

// Écouteur pour le formulaire de recherche ESPACE BENIN
const formRecherche = document.getElementById("form-recherche");
if (formRecherche) {
    formRecherche.addEventListener("submit", async (event) => {
        event.preventDefault();
        const budgetInput = document.getElementById("budget");
        const quartierInput = document.getElementById("quartier");
        const villeInput = document.getElementById("ville");
        const typeInput = document.getElementById("type"); // Champ type logement

        const budget = budgetInput && budgetInput.value ? parseInt(budgetInput.value) : null;
        const quartier = quartierInput ? quartierInput.value.trim() || null : null;
        const ville = villeInput ? villeInput.value.trim() || null : null;
        const typeLogementInput = typeInput ? typeInput.value.trim() || null : null;

        const typeRechercheSelect = document.getElementById("type-recherche");
        const selectedType = typeRechercheSelect ? typeRechercheSelect.value : 'logements';

        let finalTypeLogementFilter = null;
        if (selectedType === 'logements') {
            finalTypeLogementFilter = typeLogementInput;
        }

        const resultatsRechercheDiv = document.getElementById("resultats-recherche");
        if (resultatsRechercheDiv) {
            resultatsRechercheDiv.innerHTML = ''; // Vider avant recherche
            resultatsRechercheDiv.style.display = 'none';
        }
        toggleLoading(true); // Afficher indicateur

        try {
            const resultats = await effectuerRecherche(budget, quartier, ville, finalTypeLogementFilter);
            afficherResultatsDansLaPage(resultats);
            if (resultatsRechercheDiv) {
                resultatsRechercheDiv.style.display = 'grid'; // Afficher les résultats
            }
        } catch (error) {
            console.error("Erreur pendant la recherche:", error);
            if (resultatsRechercheDiv) {
                resultatsRechercheDiv.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: red;">Erreur lors de la recherche.</p>';
                resultatsRechercheDiv.style.display = 'grid';
            }
        } finally {
            toggleLoading(false); // Cacher indicateur
        }
    });
}

// Fonction pour créer l'affichage d'un BIEN
function creerDivBien(bien) {
    if (!bien || typeof bien !== 'object') return null;
    const divBien = document.createElement("div");
    divBien.classList.add("bien");

    if (bien.image) {
         const imgBien = document.createElement("img");
         imgBien.src = bien.image;
         imgBien.alt = bien.titre || 'Image du bien';
         imgBien.loading = 'lazy'; // Lazy loading pour les images
         imgBien.onerror = (e) => { e.target.style.display='none'; };
         divBien.appendChild(imgBien);
    }

    // Conteneur pour le texte pour une meilleure structure
    const textContainer = document.createElement('div');

    const titreBien = document.createElement("h3");
    titreBien.textContent = bien.titre || 'Bien sans titre';
    textContainer.appendChild(titreBien);

    if (bien.description) {
        const descriptionBien = document.createElement("p");
        // Limiter la description pour l'aperçu
        descriptionBien.textContent = bien.description.substring(0, 80) + (bien.description.length > 80 ? '...' : '');
        textContainer.appendChild(descriptionBien);
    }

    const prixBien = document.createElement("p");
    prixBien.textContent = (typeof bien.prix === 'number' ? `${bien.prix.toLocaleString('fr-FR')} FCFA` : 'Prix non spécifié');
    prixBien.style.fontWeight = 'bold'; // Mettre en évidence
    textContainer.appendChild(prixBien);

    if (bien.ville || bien.quartier) {
        const localisation = document.createElement("p");
        localisation.textContent = `${bien.quartier || ''}${bien.quartier && bien.ville ? ', ' : ''}${bien.ville || ''}`;
        localisation.style.fontSize = '0.9em';
        localisation.style.color = '#777';
        textContainer.appendChild(localisation);
    }

    const statutBien = document.createElement("p");
    statutBien.textContent = `Statut: ${bien.statut || 'Non spécifié'}`;
    statutBien.style.fontSize = '0.9em';
    textContainer.appendChild(statutBien);

    divBien.appendChild(textContainer); // Ajouter le conteneur de texte

    const boutonDetailsBien = document.createElement("button");
    boutonDetailsBien.textContent = "Voir les Détails";
    boutonDetailsBien.addEventListener("click", () => {
        afficherFenetreDetails(bien);
    });
    divBien.appendChild(boutonDetailsBien); // Ajouter le bouton après le texte

    return divBien;
}

// Fonction pour créer l'affichage d'un LOGEMENT
function creerDivLogement(logement) {
    if (!logement || typeof logement !== 'object') return null;
    const divLogement = document.createElement("div");
    divLogement.classList.add("logement");

    if (logement.image) {
        const imgLogement = document.createElement("img");
        imgLogement.src = logement.image;
        imgLogement.alt = logement.titre || 'Image du logement';
        imgLogement.loading = 'lazy'; // Lazy loading
        imgLogement.onerror = (e) => { e.target.style.display='none'; };
        divLogement.appendChild(imgLogement);
    }

    const textContainer = document.createElement('div');

    const titreLogement = document.createElement("h3");
    titreLogement.textContent = logement.titre || 'Logement sans titre';
    textContainer.appendChild(titreLogement);

    if (logement.description) {
        const descriptionLogement = document.createElement("p");
        descriptionLogement.textContent = logement.description.substring(0, 80) + (logement.description.length > 80 ? '...' : '');
        textContainer.appendChild(descriptionLogement);
    }

    const prixLogement = document.createElement("p");
    prixLogement.textContent = (typeof logement.prix === 'number' ? `${logement.prix.toLocaleString('fr-FR')} FCFA` : 'Prix non spécifié');
    prixLogement.style.fontWeight = 'bold';
    textContainer.appendChild(prixLogement);

    if (logement.type) {
         const typeLogementP = document.createElement("p");
         typeLogementP.textContent = `Type : ${logement.type}`;
         typeLogementP.style.fontSize = '0.9em';
         textContainer.appendChild(typeLogementP);
    }

    if (logement.ville || logement.quartier) {
         const localisation = document.createElement("p");
         localisation.textContent = `${logement.quartier || ''}${logement.quartier && logement.ville ? ', ' : ''}${logement.ville || ''}`;
         localisation.style.fontSize = '0.9em';
         localisation.style.color = '#777';
         textContainer.appendChild(localisation);
    }

    const statutLogement = document.createElement("p");
    statutLogement.textContent = `Statut: ${logement.statut || 'Non spécifié'}`;
    statutLogement.style.fontSize = '0.9em';
    textContainer.appendChild(statutLogement);

    divLogement.appendChild(textContainer);

    const boutonDetails = document.createElement("button");
    boutonDetails.textContent = "Voir les Détails";
    boutonDetails.addEventListener("click", () => {
        afficherFenetreDetails(logement);
    });
    divLogement.appendChild(boutonDetails);

    return divLogement;
}

// Fonction pour afficher les dernières publications ESPACE BENIN
async function afficherDernieresPublications() {
    const derniersLogementsContainer = document.getElementById("derniers-logements");
    if (!derniersLogementsContainer) return;

    // Afficher un message de chargement simple
    derniersLogementsContainer.innerHTML = '<p class="loading" style="text-align:center; padding: 20px;">Chargement des publications...</p>';

    let allItems = [];
    const maintenant = Date.now();

    try {
        const entreprisesSnapshot = await databaseEspaceBenin.ref('entreprises').once('value');
        const entreprisesData = entreprisesSnapshot.val();
        if (!entreprisesData) {
            derniersLogementsContainer.innerHTML = "<p style='text-align:center; padding: 20px;'>Aucune publication récente.</p>";
            return;
        }

        // Utilisation de Promise.all pour paralléliser les lectures de nom
        const entreprisePromises = Object.keys(entreprisesData).map(async (entrepriseKey) => {
            const entrepriseNomSnapshot = await databaseEspaceBenin.ref(`entreprises/${entrepriseKey}/nom`).once('value');
            const entrepriseNom = entrepriseNomSnapshot.val() || "Entreprise inconnue";
            return { entrepriseKey, entrepriseNom };
        });
        const entreprisesNoms = await Promise.all(entreprisePromises);
        const entrepriseNomMap = entreprisesNoms.reduce((acc, { entrepriseKey, entrepriseNom }) => {
            acc[entrepriseKey] = entrepriseNom;
            return acc;
        }, {});

        // Utilisation de Promise.all pour lire les logements et biens
        const itemPromises = Object.keys(entreprisesData).flatMap(entrepriseKey =>
            ['logements', 'biens'].map(async (typeRecherche) => {
                const itemsRef = databaseEspaceBenin.ref(`entreprises/${entrepriseKey}/${typeRecherche}`);
                const itemsSnapshot = await itemsRef.once('value');
                return { entrepriseKey, typeRecherche, itemsData: itemsSnapshot.val() };
            })
        );
        const allItemSnapshots = await Promise.all(itemPromises);

        allItemSnapshots.forEach(({ entrepriseKey, typeRecherche, itemsData }) => {
            if (!itemsData) return;
            const entrepriseNom = entrepriseNomMap[entrepriseKey] || "Entreprise inconnue";

            for (const itemKey of Object.keys(itemsData)) {
                const item = itemsData[itemKey];
                if (typeof item !== 'object' || item === null) continue;

                let isPaidAndUnavailable = false;
                if (item.statut === "Payé" && item.datePaiement) {
                    try {
                        const datePaiement = new Date(item.datePaiement);
                        const vingtQuatreHeures = 24 * 60 * 60 * 1000;
                        if (!isNaN(datePaiement.getTime()) && (maintenant - datePaiement.getTime() < vingtQuatreHeures)) {
                           isPaidAndUnavailable = true;
                        }
                    } catch(e) { /* Ignore invalid date */ }
                }

                if (!isPaidAndUnavailable) {
                    let datePub = 0;
                    if(item.datePublication) {
                        try { datePub = new Date(item.datePublication).getTime(); } catch(e) { datePub = 0; }
                    }
                    if (isNaN(datePub) || datePub === 0) { datePub = new Date(0).getTime(); } // Date très ancienne

                    allItems.push({
                        ...item,
                        entrepriseId: entrepriseKey,
                        entrepriseNom: entrepriseNom,
                        id: itemKey,
                        statut: item.statut || "Non spécifié",
                        typeRecherche: typeRecherche,
                        datePublicationTimestamp: datePub
                    });
                }
            }
        });

        // Trier par date (plus récent en premier)
        allItems.sort((a, b) => b.datePublicationTimestamp - a.datePublicationTimestamp);

        // Affichage du Carousel
        const MAX_CAROUSEL_ITEMS = 9; // Limite logique, mais l'affichage dépend de la vue
        const recentItems = allItems.slice(0, MAX_CAROUSEL_ITEMS);

        derniersLogementsContainer.innerHTML = ''; // Vider le chargement

        if (recentItems.length > 0) {
            const itemCarousel = document.createElement("div");
            itemCarousel.classList.add("logement-carousel"); // Appliquer la classe pour le style

            recentItems.forEach((item) => {
                const divItem = item.typeRecherche === 'logements' ? creerDivLogement(item) : creerDivBien(item);
                if (divItem) {
                     itemCarousel.appendChild(divItem);
                }
            });
            derniersLogementsContainer.appendChild(itemCarousel);
            setupCarousel(itemCarousel); // Lancer la logique JS du carousel
        } else {
            derniersLogementsContainer.innerHTML = "<p style='text-align:center; padding: 20px;'>Aucune publication récente.</p>";
        }

    } catch (error) {
        console.error("Erreur lors de l'affichage des dernières publications:", error);
        derniersLogementsContainer.innerHTML = "<p style='text-align:center; padding: 20px; color: red;'>Erreur chargement publications.</p>";
    }
}

// Fonction pour configurer et animer le carousel (MISE À JOUR POUR MOBILE)
function setupCarousel(carouselElement) {
    const slides = Array.from(carouselElement.children); // Convertir en Array
    const numSlides = slides.length;
    const container = carouselElement.parentElement; // Le div #derniers-logements
    if (!container || numSlides <= 1) {
        // Optionally hide navigation if < required slides based on view
        const visibleCount = getVisibleSlidesCount();
        if (numSlides <= visibleCount) {
           console.log("Carousel: Not enough slides to scroll.");
           // Maybe hide next/prev buttons if you add them later
        }
         // Ensure proper layout even if not scrolling
         applyCarouselStyles();
        return;
    }

    let currentItemIndex = 0;
    const intervalTime = 5000; // Temps entre chaque slide
    let slideInterval; // Variable pour l'intervalle

    // Fonction pour déterminer le nombre de slides visibles
    function getVisibleSlidesCount() {
        if (window.innerWidth < 769) return 1; // Match the CSS media query breakpoint
        // Add more breakpoints if needed (e.g., 2 for tablets)
        return 3; // 3 slides par défaut sur grand écran
    }

    // Fonction pour appliquer les styles (largeur, etc.)
    function applyCarouselStyles() {
        const visibleCount = getVisibleSlidesCount();
        // Important: slideWidthPercent refers to the % of the *container* width each visible slide takes
        const slideWidthPercent = 100 / visibleCount;

        // Total width of the carousel strip is 100% * number of slides
        // because each slide is based on the container width (especially on mobile)
        const totalWidthPercent = numSlides * 100; // Total width remains based on 100% per slide for translation
        carouselElement.style.width = `${totalWidthPercent}%`; // e.g., 500% if 5 slides

        slides.forEach((slide) => {
             // Let the CSS handle the actual visible width via flex-basis
             // We just ensure flex properties are set
             slide.style.flex = `0 0 ${100 / numSlides}%`; // Assign portion of the *total* width
             slide.style.boxSizing = 'border-box';
             // Padding is now handled purely by CSS media queries
        });

        // Reset position smoothly
        goToSlide(currentItemIndex, 'auto'); // Use 'auto' for instant jump on setup/resize

        console.log(`Carousel Styles Applied: Visible=${visibleCount}, SlideWidth=${slideWidthPercent}%, TotalWidth=${totalWidthPercent}%`);
    }

    // Fonction pour aller à un slide spécifique
    function goToSlide(index, behavior = 'smooth') {
        currentItemIndex = index; // Update the current index

        // Calculate offset based on the index. Each slide shifts the view by 100% of the container width.
        const offsetPercent = -(currentItemIndex * 100 / numSlides); // Correction: Offset based on % of TOTAL width

        carouselElement.style.transition = (behavior === 'smooth') ? 'transform 0.5s ease-in-out' : 'none';
        carouselElement.style.transform = `translateX(${offsetPercent}%)`;

        // Force reflow if instant jump is needed (important after resize or loop reset)
        if (behavior !== 'smooth') {
            carouselElement.offsetHeight; // Force reflow/repaint
             // Restore smooth transition for subsequent automatic slides
             setTimeout(() => {
                 carouselElement.style.transition = 'transform 0.5s ease-in-out';
             }, 50); // Small delay to ensure reflow completes
        }
    }


    // Fonction pour passer au slide suivant (avec boucle)
    function nextSlide() {
        const visibleCount = getVisibleSlidesCount();
        // If only one slide is visible, move one slide at a time
        // If multiple are visible (e.g., 3), we might want to advance by 'visibleCount' slides,
        // but simple 1-by-1 advance is often smoother visually. Let's stick to 1.
        let advancement = 1;

        // Calculate the next index, wrapping around
        let nextIndex = (currentItemIndex + advancement) % numSlides;

        // Check if looping back to the beginning creates a large empty space
        // This happens if the number of slides isn't a multiple of visible slides
        if (visibleCount > 1 && nextIndex !== 0 && (numSlides - nextIndex < visibleCount) && (currentItemIndex > nextIndex) ) {
             // We looped, but the end doesn't fill the view. Jump directly to the start.
             // This scenario needs careful handling for smooth loops.
             // A simpler approach for now: just go to the calculated nextIndex.
             // Visual 'jump' might occur if numSlides is not multiple of visibleCount.
             // console.log("Potential loop jump detected");
        }

        goToSlide(nextIndex, 'smooth');
    }


    // Initial setup
    applyCarouselStyles(); // Appliquer les styles initiaux
    if (numSlides > getVisibleSlidesCount()) { // Only start interval if scrolling is possible
        slideInterval = setInterval(nextSlide, intervalTime); // Démarrer l'intervalle
    }

    // Re-calculer au redimensionnement
    let resizeTimeout;
    window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
            console.log("Resizing carousel...");
            clearInterval(slideInterval); // Arrêter l'intervalle
            applyCarouselStyles(); // Recalculer les styles et repositionner
            // Redémarrer l'intervalle seulement si le défilement est nécessaire
            if (numSlides > getVisibleSlidesCount()) {
               slideInterval = setInterval(nextSlide, intervalTime);
            }
        }, 250); // Debounce resize event
    });

    // Optionnel: Pause on hover
    container.addEventListener('mouseenter', () => clearInterval(slideInterval));
    container.addEventListener('mouseleave', () => {
         if (numSlides > getVisibleSlidesCount()) { // Only restart if scrolling is possible
             clearInterval(slideInterval); // Clear just in case
             slideInterval = setInterval(nextSlide, intervalTime);
         }
    });
}


// Fonction pour afficher toutes les publications ESPACE BENIN
async function afficherTout() {
    toggleLoading(true);
    const resultatsRechercheDiv = document.getElementById("resultats-recherche");
    if (resultatsRechercheDiv) resultatsRechercheDiv.innerHTML = ''; // Vider

    let allItemsMap = {};
    const maintenant = Date.now();

    try {
        const entreprisesSnapshot = await databaseEspaceBenin.ref('entreprises').once('value');
        const entreprisesData = entreprisesSnapshot.val();
        if (!entreprisesData) {
             if(resultatsRechercheDiv) resultatsRechercheDiv.innerHTML = "<p style='grid-column: 1 / -1; text-align: center;'>Aucun élément à afficher.</p>";
            return;
        }

        // Paralléliser la récupération des noms et des items
        const fetchPromises = Object.keys(entreprisesData).map(async (entrepriseKey) => {
             const entrepriseNomSnapshot = await databaseEspaceBenin.ref(`entreprises/${entrepriseKey}/nom`).once('value');
             const entrepriseNom = entrepriseNomSnapshot.val() || "Entreprise inconnue";
             const logementsSnapshot = await databaseEspaceBenin.ref(`entreprises/${entrepriseKey}/logements`).once('value');
             const biensSnapshot = await databaseEspaceBenin.ref(`entreprises/${entrepriseKey}/biens`).once('value');
             return { entrepriseKey, entrepriseNom, logementsData: logementsSnapshot.val(), biensData: biensSnapshot.val() };
        });

        const results = await Promise.all(fetchPromises);

        results.forEach(({ entrepriseKey, entrepriseNom, logementsData, biensData }) => {
             const processItems = (itemsData, typeRecherche) => {
                 if (!itemsData) return;
                 for (const itemKey of Object.keys(itemsData)) {
                     const item = itemsData[itemKey];
                     if (typeof item !== 'object' || item === null) continue;

                     let isPaidAndUnavailable = false;
                     if (item.statut === "Payé" && item.datePaiement) {
                         try {
                             const datePaiement = new Date(item.datePaiement);
                             const vingtQuatreHeures = 24 * 60 * 60 * 1000;
                             if (!isNaN(datePaiement.getTime()) && (maintenant - datePaiement.getTime() < vingtQuatreHeures)) {
                                isPaidAndUnavailable = true;
                             }
                         } catch(e) { /* Ignore invalid date */ }
                     }

                     if (!isPaidAndUnavailable) {
                         let datePub = 0;
                         if(item.datePublication) {
                             try { datePub = new Date(item.datePublication).getTime(); } catch(e) { datePub = 0; }
                         }
                         if (isNaN(datePub) || datePub === 0) { datePub = new Date(0).getTime(); }

                         allItemsMap[itemKey + '_' + typeRecherche] = { // Clé unique
                             ...item,
                             entrepriseId: entrepriseKey,
                             entrepriseNom: entrepriseNom,
                             id: itemKey,
                             statut: item.statut || "Non spécifié",
                             typeRecherche: typeRecherche,
                             datePublicationTimestamp: datePub
                         };
                     }
                 }
             };
             processItems(logementsData, 'logements');
             processItems(biensData, 'biens');
        });


        // Trier par date et afficher
        let allItemsArray = Object.values(allItemsMap);
        allItemsArray.sort((a, b) => b.datePublicationTimestamp - a.datePublicationTimestamp);
        const sortedItemsMap = allItemsArray.reduce((acc, item) => {
            acc[item.id + '_' + item.typeRecherche] = item;
            return acc;
        }, {});

        afficherResultatsDansLaPage(sortedItemsMap);
         if (resultatsRechercheDiv) {
                resultatsRechercheDiv.style.display = 'grid';
         }

    } catch (error) {
        console.error("Erreur lors de l'affichage de tous les éléments:", error);
        if(resultatsRechercheDiv) resultatsRechercheDiv.innerHTML = '<p style="grid-column: 1 / -1; text-align: center; color: red;">Erreur chargement.</p>';
    } finally {
        toggleLoading(false);
    }
}

// Écouteur pour le bouton "Voir plus" ESPACE BENIN
const voirPlusButton = document.getElementById("voir-plus");
if (voirPlusButton) {
    voirPlusButton.addEventListener("click", () => {
        const resultSection = document.getElementById('recherche-logement');
        if (resultSection) {
           // Faire défiler vers la section des résultats (ou juste en dessous de la recherche)
           window.scrollTo({
               top: resultSection.offsetTop + resultSection.offsetHeight - 20, // Position juste après la barre de recherche
               behavior: 'smooth'
           });
        }
        afficherTout(); // Appeler la fonction pour afficher tous les éléments
    });
}

// Fonction pour afficher la fenêtre de détails ESPACE BENIN
async function afficherFenetreDetails(item) {
    // Fermer toute fenêtre de détails existante
    const existingFenetre = document.querySelector(".fenetre-details");
    if (existingFenetre) {
        document.body.removeChild(existingFenetre);
    }

    const fenetreDetails = document.createElement("div");
    fenetreDetails.classList.add("fenetre-details");

    // Parsing du prix
    let prixNumerique = 0;
    if (typeof item.prix === 'number') { prixNumerique = item.prix; }
    else if (typeof item.prix === 'string') { prixNumerique = parseFloat(item.prix.replace(/[^0-9.,]+/g, "").replace(',', '.')); } // Gérer virgule et point décimal
    if (isNaN(prixNumerique)) prixNumerique = 0;

    // Récupération infos entreprise (WhatsApp)
    let entrepriseWhatsapp = null;
    let demarcheurNom = item.demarcheur || "Non spécifié";
    let proprietaireNom = item.proprietaire || "Non spécifié";
    try {
        const entrepriseRef = databaseEspaceBenin.ref(`entreprises/${item.entrepriseId}`);
        const entrepriseSnapshot = await entrepriseRef.once('value');
        const entrepriseData = entrepriseSnapshot.val();
        if (entrepriseData && entrepriseData.whatsapp) {
             // Nettoyer le numéro WhatsApp (enlever espaces, +, etc.)
             entrepriseWhatsapp = entrepriseData.whatsapp.replace(/[^0-9]/g, '');
             // Ajouter le code pays si absent (supposons 229 pour le Bénin)
             if (entrepriseWhatsapp.length > 8 && !entrepriseWhatsapp.startsWith('229')) {
                  // Si numéro > 8 chiffres et ne commence pas par 229, on suppose qu'il manque
                  // Cette logique peut nécessiter ajustement
             } else if (entrepriseWhatsapp.length === 8) {
                  entrepriseWhatsapp = '229' + entrepriseWhatsapp;
             }
        }
    } catch(error) {
       console.error("Erreur récupération infos entreprise:", error);
   }

    // Déterminer l'état des boutons
    let texteBoutonPayerAvance = (item.typeRecherche === 'logements') ? "Payer Loyer" : "Payer Bien";
    let isReservable = item.statut !== 'Réservé' && item.statut !== 'Payé';
    let isPayable = item.statut !== 'Payé';

    // Construction du HTML de la fenêtre modale
    fenetreDetails.innerHTML = `
        <span class="close-button fenetre-close-button" title="Fermer">×</span>
        <h3>${item.titre || 'Détails'}</h3>
        ${item.image ? `<img src="${item.image}" alt="${item.titre || 'Image'}">` : ''}
        <p>${item.description || ''}</p>
        <hr style="border: none; border-top: 1px solid #eee; margin: 15px 0;">
        <p><strong>Prix :</strong> ${prixNumerique > 0 ? prixNumerique.toLocaleString('fr-FR') + ' FCFA' : 'Non spécifié'}</p>
        <p><strong>Entreprise :</strong> ${item.entrepriseNom || 'N/A'}</p>
        <p><strong>Statut :</strong> <span class="item-statut">${item.statut || 'Non spécifié'}</span></p>
        <p><strong>Localisation :</strong> ${item.quartier || ''}${item.quartier && item.ville ? ', ' : ''}${item.ville || 'Non spécifiée'}</p>

        <div class="boutons-container">
            ${entrepriseWhatsapp ? `<button class="bouton-discussion" title="Contacter via WhatsApp"><i class="fab fa-whatsapp"></i> Discuter</button>` : ''}
            <button class="bouton-infos" title="Afficher plus d'informations">Plus d'Infos</button>
            ${isReservable ? `<button class="bouton-reservation" title="Réserver ce bien">Réserver</button>` : '<button class="bouton-reservation" disabled>Non réservable</button>'}
            ${isPayable ? `<button class="bouton-payer-avance" title="Payer le montant total">${texteBoutonPayerAvance}</button>` : '<button class="bouton-payer-avance" disabled>Non payable</button>'}
        </div>

        <!-- Section Réservation (cachée) -->
        <div class="reservation-info" style="display: none;">
             <hr style="border: none; border-top: 1px solid #eee; margin: 15px 0;">
            <h4>Conditions de Réservation</h4>
            <p>Frais de réservation uniques (non remboursables) basés sur le prix :</p>
            <ul>
                <li>Prix <= 5.000 FCFA : <strong>2.000 FCFA</strong></li>
                <li>Prix 5.001 - 10.000 FCFA : <strong>3.000 FCFA</strong></li>
                <li>Prix 10.001 - 15.000 FCFA : <strong>5.000 FCFA</strong></li>
                <li>Prix 15.001 - 25.000 FCFA : <strong>10.000 FCFA</strong></li>
                <li>Prix 25.001 - 50.000 FCFA : <strong>15.000 FCFA</strong></li>
                <li>Prix > 50.000 FCFA : <strong>25.000 FCFA</strong></li>
            </ul>
            <p>Ces frais vous donnent une priorité pour une durée limitée. Confirmer vous redirigera vers la page de paiement FedaPay.</p>
            <button class="confirmer-reservation">Confirmer et Payer les Frais</button>
        </div>

        <!-- Section Infos Détaillées (cachée) -->
        <div class="infos-logement" style="display: none;">
             <hr style="border: none; border-top: 1px solid #eee; margin: 15px 0;">
            <h4>Informations détaillées</h4>
            <p><strong>Titre :</strong> ${item.titre || 'N/A'}</p>
            ${item.typeRecherche === 'logements' && item.type ? `<p><strong>Type :</strong> ${item.type}</p>` : ''}
            <p><strong>Description complète :</strong> ${item.description || 'N/A'}</p>
            <p><strong>État :</strong> ${item.etat || 'Non spécifié'}</p>
            <p><strong>Prix :</strong> ${prixNumerique > 0 ? prixNumerique.toLocaleString('fr-FR') + ' FCFA' : 'Non spécifié'}</p>
            <p><strong>Démarcheur :</strong> ${demarcheurNom}</p>
            <p><strong>Propriétaire :</strong> ${proprietaireNom}</p>
            <p><strong>Quartier :</strong> ${item.quartier || 'N/A'}</p>
            <p><strong>Ville :</strong> ${item.ville || 'N/A'}</p>
            <p><strong>Entreprise partenaire :</strong> ${item.entrepriseNom || 'N/A'}</p>
            <p><strong>Statut actuel :</strong> <span class="item-statut">${item.statut || 'Non spécifié'}</span></p>
        </div>
    `;

    document.body.appendChild(fenetreDetails); // Ajouter la fenêtre au DOM

    // --- Ajout des Écouteurs d'Événements pour la fenêtre modale ---

    // Bouton Fermer (X)
    const closeButton = fenetreDetails.querySelector(".fenetre-close-button");
    closeButton.addEventListener("click", () => document.body.removeChild(fenetreDetails));

    // Bouton Discussion WhatsApp
    const discussionButton = fenetreDetails.querySelector(".bouton-discussion");
    if (discussionButton && entrepriseWhatsapp) {
       discussionButton.addEventListener("click", () => {
           const message = `Bonjour ${item.entrepriseNom || ''}, je suis intéressé par "${item.titre || 'ce bien'}" (Prix: ${prixNumerique > 0 ? prixNumerique.toLocaleString('fr-FR') + ' FCFA' : ''}) vu sur ESPACE BENIN.`;
           window.open(`https://wa.me/${entrepriseWhatsapp}?text=${encodeURIComponent(message)}`, '_blank', 'noopener,noreferrer');
       });
    } else if (discussionButton) {
        discussionButton.disabled = true; // Désactiver si pas de numéro
        discussionButton.title = "Numéro WhatsApp non disponible";
    }

    // Bouton Plus d'Infos
    const infoButton = fenetreDetails.querySelector(".bouton-infos");
    const infoDiv = fenetreDetails.querySelector(".infos-logement");
    const reservDiv = fenetreDetails.querySelector(".reservation-info"); // Pour le cacher si info affichée
    if (infoButton && infoDiv) {
        infoButton.addEventListener("click", () => {
           if (reservDiv) reservDiv.style.display = "none"; // Cacher l'autre section
           infoDiv.style.display = infoDiv.style.display === "none" ? "block" : "none"; // Basculer l'affichage
        });
    }

    // Bouton Réserver (pour afficher les conditions)
    const reservButton = fenetreDetails.querySelector(".bouton-reservation");
    if (reservButton && reservDiv && isReservable) { // Vérifier si réservable
        reservButton.addEventListener("click", () => {
            if (infoDiv) infoDiv.style.display = "none"; // Cacher l'autre section
           reservDiv.style.display = "block"; // Afficher la section réservation
        });
    }

    // Bouton Confirmer la Réservation (et paiement des frais)
    const confirmReservButton = fenetreDetails.querySelector(".confirmer-reservation");
    if (confirmReservButton && isReservable) {
       confirmReservButton.addEventListener("click", async () => {
           let frais = 0;
           // Calcul des frais
           if (prixNumerique <= 5000) frais = 2000;
           else if (prixNumerique <= 10000) frais = 3000;
           else if (prixNumerique <= 15000) frais = 5000;
           else if (prixNumerique <= 25000) frais = 10000;
           else if (prixNumerique <= 50000) frais = 15000;
           else if (prixNumerique > 50000) frais = 25000;
           else { alert("Impossible de calculer les frais pour ce prix."); return; } // Prix <= 0

           const confirmation = confirm(`Vous allez payer ${frais.toLocaleString('fr-FR')} FCFA (frais de réservation non remboursables) pour "${item.titre}". Continuer vers FedaPay ?`);
           if (!confirmation) return;

           // Désactiver boutons pendant la transaction
           confirmReservButton.disabled = true;
           confirmReservButton.textContent = "Traitement...";
           if(reservButton) reservButton.disabled = true;

           const itemRef = databaseEspaceBenin.ref(`entreprises/${item.entrepriseId}/${item.typeRecherche}/${item.id}`);
           try {
               // --- Intégration FedaPay pour les Frais ---
               const fedaPayPublicKey = 'pk_live_TfSz212W0xSMKK7oPEogkFmp'; // METTRE VOTRE CLÉ PUBLIQUE ICI
               var fedaPayInstance = FedaPay.init({
                   public_key: fedaPayPublicKey,
                   transaction: {
                       amount: frais,
                       description: `Frais Réservation: ${item.titre.substring(0,50)} (${item.id})` // Description concise
                   },
                   customer: {
                       email: 'client@reserve.com' // Email générique, remplacez si vous avez l'email user
                   },
                   onComplete: async function(resp) {
                       if (resp.reason === FedaPay.CHECKOUT_COMPLETED) {
                           // Le paiement des frais a réussi -> Mettre à jour Firebase
                           try {
                               await itemRef.update({
                                   statut: "Réservé",
                                   dateReservation: new Date().toISOString(),
                                   transactionFraisId: resp.id // Sauvegarder l'ID de transaction FedaPay
                               });
                               // Mettre à jour l'interface dans la modale
                               fenetreDetails.querySelectorAll(".item-statut").forEach(el => el.textContent = "Réservé");
                               if(reservButton) reservButton.disabled = true; // Bouton Réserver principal
                               if(confirmReservButton) confirmReservButton.style.display = 'none'; // Cacher bouton confirmer
                               if(reservDiv) reservDiv.innerHTML = "<p style='color:green; font-weight:bold;'>Frais de réservation payés avec succès ! Le bien est réservé.</p>"; // Message de succès
                               alert("Frais de réservation payés avec succès !");
                           } catch (dbError) {
                               console.error("Erreur MAJ Firebase après paiement frais:", dbError);
                               alert("Paiement des frais réussi, mais erreur MAJ statut. Contactez le support.");
                               // Important: Le paiement a eu lieu, mais Firebase n'est pas à jour. Gérer manuellement ?
                                confirmReservButton.disabled = false; // Réactiver pour retenter ?
                                confirmReservButton.textContent = "Confirmer et Payer les Frais";
                                if(reservButton) reservButton.disabled = false;
                           }
                       } else {
                           // Le paiement FedaPay a échoué ou a été annulé
                           alert("Le paiement des frais a échoué ou a été annulé.");
                           confirmReservButton.disabled = false; // Réactiver
                           confirmReservButton.textContent = "Confirmer et Payer les Frais";
                           if(reservButton) reservButton.disabled = false;
                       }
                   }
               });
               fedaPayInstance.open(); // Ouvre le checkout FedaPay

           } catch (error) { // Erreur avant même d'appeler FedaPay
               console.error("Erreur avant init FedaPay (frais):", error);
               alert("Erreur lors de l'initialisation du paiement des frais.");
               confirmReservButton.disabled = false;
               confirmReservButton.textContent = "Confirmer et Payer les Frais";
                if(reservButton) reservButton.disabled = false;
           }
       });
    }

    // Bouton Payer (montant total)
    const payerButton = fenetreDetails.querySelector(".bouton-payer-avance");
    if (payerButton && isPayable) {
        payerButton.addEventListener("click", async () => {
           if (prixNumerique <= 0) { alert("Prix invalide pour le paiement."); return; }

           const confirmation = confirm(`Vous allez payer le montant total de ${prixNumerique.toLocaleString('fr-FR')} FCFA pour "${item.titre}". Continuer vers FedaPay ?`);
           if (!confirmation) return;

           // Désactiver boutons
           payerButton.disabled = true;
           payerButton.textContent = "Traitement...";
           if(reservButton) reservButton.disabled = true; // Aussi désactiver réservation si on paie
           if(confirmReservButton) confirmReservButton.disabled = true;

           const itemRef = databaseEspaceBenin.ref(`entreprises/${item.entrepriseId}/${item.typeRecherche}/${item.id}`);
           try {
                // --- Intégration FedaPay pour Paiement Total ---
               const fedaPayPublicKey = 'pk_live_TfSz212W0xSMKK7oPEogkFmp'; // METTRE VOTRE CLÉ PUBLIQUE ICI
               var fedaPayInstance = FedaPay.init({
                   public_key: fedaPayPublicKey,
                   transaction: {
                       amount: prixNumerique,
                       description: `Paiement: ${item.titre.substring(0, 50)} (${item.id})`
                   },
                   customer: {
                       email: 'client@paiement.com' // Email générique
                   },
                   onComplete: async function(resp) {
                       if (resp.reason === FedaPay.CHECKOUT_COMPLETED) {
                           // Paiement FedaPay réussi -> Mettre à jour Firebase
                           try {
                               await itemRef.update({
                                   statut: "Payé",
                                   datePaiement: new Date().toISOString(),
                                   transactionPaiementId: resp.id // Sauvegarder ID transaction
                               });
                               // Mettre à jour l'interface
                               fenetreDetails.querySelectorAll(".item-statut").forEach(el => el.textContent = "Payé");
                               if(payerButton) payerButton.disabled = true; // Bouton Payer désactivé
                               if(reservButton) reservButton.disabled = true; // Bouton Réserver désactivé
                               if(confirmReservButton) confirmReservButton.disabled = true; // Bouton Confirmer Resa désactivé
                               if(reservDiv) reservDiv.style.display = 'none'; // Cacher section résa
                               alert("Paiement effectué et statut mis à jour !");
                           } catch (dbError) {
                               console.error("Erreur MAJ Firebase après paiement total:", dbError);
                               alert("Paiement réussi, mais erreur MAJ statut. Contactez le support.");
                                // Important: Paiement fait, mais Firebase pas à jour.
                                payerButton.disabled = false;
                                payerButton.textContent = texteBoutonPayerAvance;
                                if(isReservable && reservButton) reservButton.disabled = false;
                                if(isReservable && confirmReservButton) confirmReservButton.disabled = false;
                           }
                       } else {
                           // Paiement FedaPay échoué/annulé
                           alert("Le paiement a échoué ou a été annulé.");
                           payerButton.disabled = false; // Réactiver
                           payerButton.textContent = texteBoutonPayerAvance;
                            if(isReservable && reservButton) reservButton.disabled = false;
                            if(isReservable && confirmReservButton) confirmReservButton.disabled = false;
                       }
                   }
               });
               fedaPayInstance.open(); // Ouvre le checkout FedaPay

           } catch (error) { // Erreur avant FedaPay
               console.error("Erreur avant init FedaPay (total):", error);
               alert("Erreur lors de l'initialisation du paiement total.");
               payerButton.disabled = false;
               payerButton.textContent = texteBoutonPayerAvance;
                if(isReservable && reservButton) reservButton.disabled = false;
                if(isReservable && confirmReservButton) confirmReservButton.disabled = false;
           }
       });
    }
} // --- Fin afficherFenetreDetails ---

// Gestion du menu mobile ESPACE BENIN
const menuToggle = document.getElementById("menu-toggle");
const mainNav = document.getElementById("main-nav"); // Cibler la <nav>
if (menuToggle && mainNav) {
    menuToggle.addEventListener("click", () => {
       mainNav.classList.toggle("visible"); // Ajouter/retirer la classe pour afficher/cacher
    });

    // Fermeture en cliquant sur un lien du menu
    mainNav.querySelectorAll('a').forEach(link => {
        link.addEventListener('click', () => {
            mainNav.classList.remove('visible');
        });
    });

    // Fermeture en cliquant en dehors du menu (sur mobile)
    document.addEventListener('click', (event) => {
        // Vérifier si le clic est en dehors de la nav ET du bouton toggle, ET que la nav est visible
        if (!mainNav.contains(event.target) && !menuToggle.contains(event.target) && mainNav.classList.contains('visible')) {
            mainNav.classList.remove('visible');
        }
    });
}

// Fonction pour afficher les témoignages ESPACE BENIN
async function afficherTemoignages() {
    const container = document.querySelector(".temoignages-container");
    if (!container) return;
    container.innerHTML = "<p class='loading' style='text-align:center; padding: 20px;'>Chargement...</p>";

    try {
        // Limiter à 6 avis, triés par date descendante
        const avisSnapshot = await databaseEspaceBenin.ref('avis').orderByChild('date').limitToLast(6).once('value');
        const avisData = avisSnapshot.val();
        container.innerHTML = ""; // Vider le chargement

        if (avisData) {
            // Trier côté client car Firebase limitToLast ne garantit pas l'ordre avec orderByChild si dates identiques
            const avisArray = Object.keys(avisData)
                                   .map(key => ({ id: key, ...avisData[key] }))
                                   .sort((a, b) => new Date(b.date).getTime() - new Date(a.date).getTime());

            if (avisArray.length > 0) {
                 avisArray.forEach(unAvis => {
                    const div = document.createElement("div");
                    div.classList.add("temoignage");
                    const dateAffichage = unAvis.date ? new Date(unAvis.date).toLocaleDateString('fr-FR', { year: 'numeric', month: 'short', day: 'numeric' }) : '';
                    div.innerHTML = `
                        <p>"${unAvis.texte || ''}"</p>
                        <p class="temoignage-auteur">- ${unAvis.nom || 'Anonyme'} ${dateAffichage ? `(${dateAffichage})` : ''}</p>
                    `;
                    container.appendChild(div);
                });
            } else {
                container.innerHTML = "<p style='text-align:center; padding: 20px;'>Aucun témoignage pour le moment.</p>";
            }
        } else {
            container.innerHTML = "<p style='text-align:center; padding: 20px;'>Aucun témoignage pour le moment.</p>";
        }
    } catch (error) {
        console.error("Erreur récupération avis:", error);
        container.innerHTML = "<p style='text-align:center; padding: 20px; color: red;'>Erreur chargement témoignages.</p>";
    }
}

// Écouteur pour l'ajout d'avis ESPACE BENIN
const formAjoutAvis = document.getElementById("form-ajout-avis");
if (formAjoutAvis) {
    formAjoutAvis.addEventListener("submit", async (event) => {
        event.preventDefault();
        const nomInput = document.getElementById("avis-nom");
        const emailInput = document.getElementById("avis-email");
        const texteInput = document.getElementById("avis-texte");
        const submitButton = formAjoutAvis.querySelector('button[type="submit"]');

        const nom = nomInput ? nomInput.value.trim() : '';
        const email = emailInput ? emailInput.value.trim() : '';
        const texte = texteInput ? texteInput.value.trim() : '';

        // Validation simple
        if (!nom || !texte) { alert("Veuillez saisir votre nom et votre témoignage."); return; }
        if (email && !/\S+@\S+\.\S+/.test(email)) { alert("Veuillez saisir une adresse email valide."); return; }

        if (submitButton) { submitButton.disabled = true; submitButton.textContent = "Envoi..."; }

        try {
            const newAvisRef = databaseEspaceBenin.ref('avis').push(); // Utiliser la bonne référence DB
            await newAvisRef.set({
                nom: nom,
                email: email, // Sauvegarder même si facultatif
                texte: texte,
                date: new Date().toISOString() // Format ISO pour tri facile
            });
            formAjoutAvis.reset(); // Vider le formulaire
            alert("Avis ajouté avec succès ! Merci.");
            afficherTemoignages(); // Rafraîchir l'affichage
        } catch (error) {
            console.error("Erreur ajout avis:", error);
            alert("Une erreur est survenue lors de l'ajout. Veuillez réessayer.");
        } finally {
             if (submitButton) { submitButton.disabled = false; submitButton.textContent = "Soumettre l'avis"; }
        }
    });
}

// Appel initial pour afficher les témoignages au chargement
document.addEventListener('DOMContentLoaded', afficherTemoignages);

// Gestion des modales Termes & Confidentialité
function setupModal(modalId, triggerIds) {
    const modal = document.getElementById(modalId);
    // Utiliser querySelector pour cibler le bouton de fermeture à l'intérieur de la modale spécifique
    const closeButton = modal ? modal.querySelector('.close-button') : null;

    if (!modal || !closeButton) {
        console.warn(`Modal or close button not found for ID: ${modalId}`);
        return; // Ne rien faire si les éléments n'existent pas
    }

    const openModal = (event) => {
         event.preventDefault();
         modal.style.display = 'block';
    };
    const closeModal = () => {
         modal.style.display = 'none';
    };

     triggerIds.forEach(id => {
         const trigger = document.getElementById(id);
         if (trigger) {
             trigger.addEventListener('click', openModal);
         } else {
             console.warn(`Trigger element not found for ID: ${id}`);
         }
     });

    closeButton.addEventListener('click', closeModal);

    // Fermeture en cliquant en dehors du contenu de la modale
    modal.addEventListener('click', (event) => {
        if (event.target === modal) { // Si le clic est sur le fond de la modale
            closeModal();
        }
    });
}

// Initialisation des modales au chargement
document.addEventListener('DOMContentLoaded', () => {
    setupModal('privacy-modal', ['show-privacy', 'show-privacy-footer']);
    setupModal('terms-modal', ['show-terms', 'show-terms-footer']);
});


// Gestion de l'affichage dynamique des champs de recherche
const typeRechercheSelect = document.getElementById("type-recherche");
const champsLogementsDiv = document.getElementById("champs-logements");
const champsBiensDiv = document.getElementById("champs-biens");

if (typeRechercheSelect && champsLogementsDiv && champsBiensDiv) {
    const handleTypeChange = () => {
        const selectedValue = typeRechercheSelect.value;
        // Cacher les deux par défaut
        champsLogementsDiv.classList.remove('visible');
        champsBiensDiv.classList.remove('visible');
        champsLogementsDiv.style.display = 'none';
        champsBiensDiv.style.display = 'none';

        if (selectedValue === "logements") {
            champsLogementsDiv.classList.add('visible');
            champsLogementsDiv.style.display = 'contents'; // Utiliser 'contents' pour grid
        } else if (selectedValue === "biens") {
            // Afficher les champs biens seulement s'ils contiennent quelque chose
            if (champsBiensDiv.innerHTML.trim() !== '') {
                champsBiensDiv.classList.add('visible');
                champsBiensDiv.style.display = 'contents'; // Utiliser 'contents' pour grid
            }
        }
    };
    handleTypeChange(); // Appliquer l'état initial
    typeRechercheSelect.addEventListener("change", handleTypeChange);
}

// Redirection vers l'espace admin ESPACE BENIN
const adminLoginButton = document.getElementById('admin-login-button');
if (adminLoginButton) {
    adminLoginButton.addEventListener('click', () => {
        window.location.href = 'admin.html'; // Assurez-vous que admin.html existe
    });
}

// --- DANS LA SECTION 2: SIMPLE Gemini Chatbot Logic ---

// ATTENTION: Mettre votre clé API Gemini ici. NON SÉCURISÉ EN PRODUCTION!
const GEMINI_API_KEY = 'AIzaSyDetgN_odqwqvU2AbaHzzijsi0yDRSveDM'; // <--- REMPLACEZ CECI !

// Définir l'instruction système pour le chatbot
const CHATBOT_SYSTEM_INSTRUCTION = `
Tu es l'assistant virtuel officiel d'Espace Benin, une plateforme immobilière en ligne basée au Bénin. Ton rôle principal est d'aider les utilisateurs à naviguer sur le site espacebenin.netlify.app, à comprendre ses fonctionnalités et à trouver les informations qu'ils recherchent concernant la location et l'achat de biens immobiliers (logements) et d'autres biens divers listés par nos partenaires (agences ou particuliers).

**Ta mission est de:**
1.  **Guider les utilisateurs:** Aide-les à utiliser efficacement la barre de recherche, à comprendre les filtres et à interpréter les résultats.
2.  **Expliquer les fonctionnalités:** Clarifie le fonctionnement des différentes sections comme "Dernières publications", "Comment ça marche ?", "Services", "Témoignages".
3.  **Détailler les processus:** Explique comment fonctionnent la réservation et le paiement via les liens FedaPay intégrés dans les détails des annonces.
4.  **Fournir des informations contextuelles:** Réponds aux questions sur les types de biens disponibles (logements comme chambres, appartements; biens divers), les localisations (villes, quartiers mentionnés), les statuts des annonces ("Non spécifié", "Réservé", "Payé").
5.  **Orienter les utilisateurs:** Redirige les utilisateurs vers les sections appropriées du site (Contact, Espace Admin, Termes, Confidentialité) ou les encourage à utiliser les boutons d'action sur les annonces (Voir Détails, WhatsApp).

**Informations Clés sur Espace Benin que tu dois connaître et utiliser:**
*   **Recherche:**
    *   Les utilisateurs peuvent rechercher des "Logements" ou des "Biens Divers".
    *   Filtres disponibles: Budget maximum (en FCFA), Ville, Quartier/Zone.
    *   Pour les "Logements", un filtre "Type" (ex: Chambre, Appartement) est aussi disponible.
*   **Listings / Annonces:**
    *   Affichés sous forme de cartes avec image, titre, courte description, prix (en FCFA), localisation (quartier, ville), et statut.
    *   Le bouton "Voir les Détails" ouvre une fenêtre modale (fenetre-details).
*   **Fenêtre Détails:**
    *   Affiche les informations complètes: description, état, type (si logement), démarcheur, propriétaire (si renseignés), nom de l'agence partenaire.
    *   Boutons importants:
        *   **"Discuter" (icône WhatsApp):** Ouvre une discussion WhatsApp directe avec l'agence/partenaire (si le numéro est disponible). TU DOIS ENCOURAGER L'UTILISATEUR À CLIQUER SUR CE BOUTON pour contacter l'agence, ne fournis PAS directement de numéro de téléphone.
        *   **"Plus d'Infos":** Affiche des détails supplémentaires dans la modale.
        *   **"Réserver":** Affiche les conditions de réservation et les frais associés (basés sur le prix du bien, payables via FedaPay, non remboursables). Explique que cela donne une priorité.
        *   **"Payer Loyer/Bien":** Permet de payer le montant total via FedaPay.
    *   **Statuts:** "Réservé" signifie que les frais de réservation ont été payés (potentiellement en attente de confirmation FedaPay). "Payé" signifie que le montant total a été payé. Les biens marqués "Payé" sont temporairement indisponibles (environ 24h après paiement).
*   **FedaPay:** C'est la plateforme de paiement utilisée pour les frais de réservation et le paiement total. Les utilisateurs sont redirigés vers FedaPay lorsqu'ils cliquent sur "Confirmer la Réservation" ou "Payer". Tu ne traites PAS les paiements toi-même.
*   **Autres Sections:**
    *   **Dernières publications:** Un carousel des biens récents. Le bouton "Voir plus" affiche tous les biens disponibles.
    *   **Services:** Location (maisons, appartements, véhicules), Vente (parcelles), Construction BTP, Hôtels/Motels.
    *   **Espace Admin:** Un lien vers admin.html pour les partenaires/propriétaires pour gérer leurs annonces. Tu n'as PAS accès à cet espace.
    *   **Témoignages:** Affiche les avis des utilisateurs et permet d'en soumettre un.
    *   **Contact:** Fournit les liens WhatsApp, Facebook, Email et l'adresse physique (Banikanni, Parakou).
    *   **Termes & Confidentialité:** Accessibles via des liens en pied de page et des modales.

**Ton Style de Communication:**
*   **Langue:** Français principalement. Sois prêt à comprendre d'autres langues mais réponds en français clair et simple.
*   **Ton:** Professionnel, serviable, patient et amical.
*   **Format:** Utilise des listes à puces si nécessaire pour clarifier les étapes ou les options. Garde les réponses relativement concises.
*   **Devise:** Toujours utiliser FCFA pour parler des prix.
*   **Contextualisation:** Base tes réponses sur les informations présentes et les fonctionnalités du site Espace Benin.

**Tes Limites (Ce que tu NE PEUX PAS faire):**
*   **Accéder aux données en temps réel:** Tu ne connais pas la disponibilité exacte d'un bien à l'instant T, sauf si son statut est "Réservé" ou "Payé" dans les données affichées. Encourage l'utilisateur à contacter l'agence via WhatsApp pour confirmation.
*   **Négocier les prix:** Les prix sont fixés par les partenaires.
*   **Organiser des visites:** L'utilisateur doit contacter l'agence via le bouton WhatsApp pour cela.
*   **Traiter les paiements directement:** Tu ne fais qu'expliquer le processus via FedaPay.
*   **Donner des conseils juridiques ou financiers:** Restreins-toi à l'information factuelle du site.
*   **Accéder aux comptes utilisateurs ou à l'espace admin.**
*   **Fournir des informations non présentes sur le site** (par exemple, des détails sur un quartier non listé, des lois spécifiques sur l'immobilier au Bénin non mentionnées, etc.). Dans ce cas, indique que l'information n'est pas disponible sur le site et suggère de contacter Espace Benin directement.

**Exemple d'interaction:**
*   *Utilisateur:* "Comment je peux louer la chambre à Agla à 30000 FCFA ?"
*   *Toi (suggestion):* "Pour la chambre à Agla, vous pouvez cliquer sur le bouton 'Voir les Détails' sur l'annonce. Ensuite, dans la fenêtre qui s'ouvre, vous trouverez un bouton 'Discuter' (avec l'icône WhatsApp) pour contacter directement l'agence et organiser une visite ou poser vos questions. Vous pouvez aussi voir si l'option 'Réserver' est disponible pour payer les frais et avoir une priorité."

Sois précis, utile et concentre-toi sur l'aide à l'utilisation du site Espace Benin !
`;

let chatbotGenAI;      // Instance de l'API Gemini pour le chatbot
let chatbotModel;      // Instance du modèle Gemini pour le chatbot
let currentChatbotConversation = []; // Historique pour ce chatbot
const MAX_CHATBOT_HISTORY = 6; // Garder les 3 derniers échanges

// Fonction d'initialisation spécifique pour le chatbot Gemini (MISE À JOUR)
function initializeChatbotGeminiAPI() {
    // Vérifier si le SDK est chargé
    if (typeof window.GoogleGenerativeAI === 'undefined') {
        console.error("GoogleGenerativeAI SDK non chargé.");
        showChatbotNotification("Erreur SDK.", "error");
        return false; // Indiquer l'échec
    }
    // Vérifier si la clé API a été mise
    if (!GEMINI_API_KEY || GEMINI_API_KEY === 'VOTRE_CLE_API_GEMINI_ICI') { // Added check for empty key
        console.error("Clé API Gemini manquante pour le chatbot.");
        showChatbotNotification("Clé API manquante.", "error");
        return false; // Indiquer l'échec
    }

    try {
        // Initialiser seulement si pas déjà fait ou si l'initialisation précédente a échoué
        if (!chatbotGenAI || !chatbotModel) {
             chatbotGenAI = new window.GoogleGenerativeAI(GEMINI_API_KEY);
             // Utiliser le modèle flash recommandé ET AJOUTER L'INSTRUCTION SYSTEME
             chatbotModel = chatbotGenAI.getGenerativeModel({
                 model: "gemini-1.5-flash-latest",
                 systemInstruction: CHATBOT_SYSTEM_INSTRUCTION // <--- INSTRUCTION AJOUTÉE ICI
             });
             console.log("API Gemini initialisée pour le Chatbot avec instruction système.");
        }
        return true; // Succès
    } catch (error) {
        console.error("Échec initialisation API Gemini Chatbot:", error);
        showChatbotNotification("Erreur init assistant.", "error");
        // Réinitialiser pour permettre une nouvelle tentative plus tard
        chatbotGenAI = null;
        chatbotModel = null;
        return false; // Indiquer l'échec
    }
}

// Afficher un message dans la fenêtre du chatbot flottant
function displayChatbotMessage(sender, text) {
    const messagesContainer = document.getElementById('chatbot-messages');
    if (!messagesContainer) return null;

    const messageElement = document.createElement('div');
    messageElement.classList.add('message', sender === 'user' ? 'user-message' : 'ai-message');

    // Utiliser textContent pour la sécurité par défaut
    const textNode = document.createElement('div');
    textNode.textContent = text;
    messageElement.appendChild(textNode);

    messagesContainer.appendChild(messageElement);
    // Scroll automatique vers le bas
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    return messageElement;
}

// Afficher l'indicateur "..." dans le chatbot
function showChatbotTypingIndicator() {
    const messagesContainer = document.getElementById('chatbot-messages');
    if (!messagesContainer) return;

    // Enlever l'ancien indicateur s'il existe
    const existingIndicator = messagesContainer.querySelector('.typing-indicator-message');
    if (existingIndicator) existingIndicator.remove();

    const indicatorElement = document.createElement('div');
    indicatorElement.classList.add('message', 'ai-message', 'typing-indicator-message');
    indicatorElement.innerHTML = `
        <div class="typing-indicator">
            <span></span><span></span><span></span>
        </div>
    `;
    messagesContainer.appendChild(indicatorElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;
    return indicatorElement;
}

// Animer la réponse du chatbot caractère par caractère
async function animateChatbotText(element, text) {
    const contentDiv = document.createElement('div'); // Créer un conteneur pour le texte
    element.innerHTML = ''; // Vider l'indicateur "..."
    element.appendChild(contentDiv);
    element.classList.remove('typing-indicator-message'); // Retirer la classe de l'indicateur

    let currentText = '';
    const delay = 10; // Délai rapide pour l'animation

    try {
         for (let i = 0; i < text.length; i++) {
            currentText += text[i];
            contentDiv.textContent = currentText; // Mettre à jour le texte

            // Scroll auto
            const messagesContainer = document.getElementById('chatbot-messages');
            if(messagesContainer) messagesContainer.scrollTop = messagesContainer.scrollHeight;

            await new Promise(resolve => setTimeout(resolve, delay));
         }
    } catch (error) {
         console.warn("Animation interrompue:", error);
         contentDiv.textContent = text; // Afficher le texte complet si l'animation échoue
    } finally {
         // Optionnel : Ajouter des boutons d'action (copier...) ici si nécessaire
    }
}

// Envoyer un message au chatbot et traiter la réponse
async function sendChatbotMessage() {
    const inputElement = document.getElementById('chatbot-input');
    const sendButton = document.getElementById('chatbot-send');
    if (!inputElement || !sendButton) return;

    const userInput = inputElement.value.trim();
    if (!userInput) return;

    // Initialiser l'API si ce n'est pas déjà fait (ou si ça a échoué avant)
    if (!chatbotGenAI || !chatbotModel) {
        if (!initializeChatbotGeminiAPI()) { // Tenter d'initialiser
             // Message d'erreur déjà affiché par initializeChatbotGeminiAPI
            return;
        }
    }

    inputElement.value = '';
    inputElement.style.height = 'auto';
    sendButton.disabled = true;

    // Afficher message user et ajouter à l'historique
    displayChatbotMessage('user', userInput);
    currentChatbotConversation.push({ role: "user", parts: [{ text: userInput }] });

    const loadingIndicator = showChatbotTypingIndicator();

    // Préparer l'historique pour l'API (limité)
    const history = currentChatbotConversation.slice(0, -1) // Tout sauf le dernier message user
                                     .slice(-MAX_CHATBOT_HISTORY); // Garder seulement les X derniers échanges

    try {
        // Démarrer une session de chat avec l'historique
        const chat = chatbotModel.startChat({ history: history });
        const result = await chat.sendMessage(userInput); // Envoyer le message actuel
        const response = await result.response;
        const aiResponseText = response.text();

        // Animer la réponse à la place de l'indicateur
        await animateChatbotText(loadingIndicator, aiResponseText);

        // Ajouter la réponse AI à l'historique local
        currentChatbotConversation.push({ role: "model", parts: [{ text: aiResponseText }] });

        // Limiter la taille de l'historique local
        if (currentChatbotConversation.length > MAX_CHATBOT_HISTORY + 2) {
            currentChatbotConversation = currentChatbotConversation.slice(-(MAX_CHATBOT_HISTORY + 2));
        }

    } catch (error) {
        console.error("Erreur API Gemini Chatbot:", error);
        if (loadingIndicator) loadingIndicator.remove();
        let errorMessage = `Désolé, une erreur est survenue.`;
        if (error.message && (error.message.includes('Quota exceeded') || error.message.includes('RATE_LIMIT_EXCEEDED'))) {
             errorMessage = "J'ai reçu trop de questions récemment. Veuillez réessayer dans un petit moment.";
        } else if (error.message && error.message.includes('API key not valid')) {
             errorMessage = "La clé d'accès à l'IA semble invalide. Veuillez contacter l'administrateur.";
        } else if (error.status === 429) { // Handle explicit 429 status
            errorMessage = "J'ai reçu trop de questions récemment. Veuillez réessayer dans un petit moment.";
        }
        displayChatbotMessage('ai', errorMessage);
        // Ne pas retenter automatiquement dans cette version simple
    } finally {
        sendButton.disabled = false;
        inputElement.focus();
    }
}

// Fonction simple pour afficher des notifications DANS le chatbot
function showChatbotNotification(message, type = 'info') {
    const messagesContainer = document.getElementById('chatbot-messages');
    if (!messagesContainer) return;

    const notifElement = document.createElement('div');
    notifElement.style.textAlign = 'center';
    notifElement.style.fontSize = '0.8em';
    notifElement.style.padding = '5px';
    notifElement.style.color = type === 'error' ? 'red' : '#888';
    notifElement.textContent = message;
    messagesContainer.appendChild(notifElement);
    messagesContainer.scrollTop = messagesContainer.scrollHeight;

    // Auto-disparition après quelques secondes
    setTimeout(() => {
        if (notifElement.parentNode === messagesContainer) {
            messagesContainer.removeChild(notifElement);
        }
    }, 5000); // Disparaît après 5 secondes
}


// --- Section 3: DOMContentLoaded / Initialisation Générale ---

document.addEventListener('DOMContentLoaded', () => {
    // Initialisations pour ESPACE BENIN
    afficherDernieresPublications();
    afficherTemoignages();
    setupModal('privacy-modal', ['show-privacy', 'show-privacy-footer']);
    setupModal('terms-modal', ['show-terms', 'show-terms-footer']);
    // Le reste (menu, recherche dynamique) est déjà géré par des écouteurs ajoutés directement après la définition des fonctions

    // Initialisation du thème (si la fonction existe)
    // const savedTheme = localStorage.getItem('theme') || 'light';
    // document.body.setAttribute('data-theme', savedTheme);
    // const themeToggleBtn = document.querySelector('.theme-toggle');
    // if(themeToggleBtn) themeToggleBtn.addEventListener('click', toggleTheme);

    // Initialisations et écouteurs pour le Chatbot Flottant
    const chatbotToggle = document.getElementById('chatbot-toggle');
    const chatbotWindow = document.getElementById('chatbot-window');
    const chatbotClose = document.getElementById('chatbot-close');
    const chatbotSend = document.getElementById('chatbot-send');
    const chatbotInput = document.getElementById('chatbot-input');

    if (chatbotToggle && chatbotWindow && chatbotClose && chatbotSend && chatbotInput) {
        // Ouvrir/Fermer le chat
        chatbotToggle.addEventListener('click', () => {
            const isVisible = chatbotWindow.classList.toggle('visible');
            if (isVisible) {
                chatbotInput.focus();
                // Initialiser l'API seulement lors de la première ouverture ou si elle a échoué
                if (!chatbotGenAI && !chatbotModel) {
                    initializeChatbotGeminiAPI();
                }
            }
        });
        chatbotClose.addEventListener('click', () => {
            chatbotWindow.classList.remove('visible');
        });

        // Envoyer le message via bouton ou Entrée
        chatbotSend.addEventListener('click', sendChatbotMessage);
        chatbotInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendChatbotMessage();
            }
        });

        // Ajustement hauteur textarea
        chatbotInput.addEventListener('input', () => {
            chatbotInput.style.height = 'auto'; // Réinitialiser
            // Limiter la hauteur maximale pour éviter que ça devienne trop grand
            const maxHeight = 100; // en pixels
            const scrollHeight = chatbotInput.scrollHeight;
            chatbotInput.style.height = Math.min(scrollHeight, maxHeight) + 'px';
        });

    } else {
        console.error("Éléments HTML du chatbot flottant non trouvés ! Vérifiez les IDs.");
    }
});

// Optionnel: Fonction toggleTheme si vous avez un bouton pour ça
function toggleTheme() {
    const body = document.body;
    const currentTheme = body.getAttribute('data-theme') || 'light';
    const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
    body.setAttribute('data-theme', newTheme);
    localStorage.setItem('theme', newTheme);
    // Mettre à jour icône si nécessaire
    // const themeIcon = document.querySelector('.theme-toggle i');
    // if(themeIcon) themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
}


// --- FIN DU SCRIPT COMBINÉ ---
    </script>

</body>
</html>